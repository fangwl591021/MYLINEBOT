<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>åç‰‡ç·¨è¼¯å™¨</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Noto Sans TC", sans-serif;
  background: #0f0f10;
  color: #fff;
}
.container {
  max-width: 420px;
  margin: auto;
  padding: 16px;
}
input {
  width: 100%;
  padding: 10px;
  margin-top: 10px;
  border-radius: 6px;
  border: none;
  background: #2a2c31;
  color: #fff;
}
button {
  width: 100%;
  margin-top: 16px;
  padding: 12px;
  border-radius: 8px;
  border: none;
  background: #c9a24d;
  color: #000;
  font-size: 16px;
}
.small {
  font-size: 13px;
  color: #aaa;
  margin-top: 6px;
}
.avatar {
  width: 64px;
  height: 64px;
  border-radius: 12px;
  margin-bottom: 12px;
}
</style>
</head>

<body>
<div class="container" id="app">
  <div id="status">INIT...</div>
</div>

<script>
/* =========================
   è¨­å®šï¼ˆå¿…æ”¹ï¼‰
========================= */
const LIFF_ID = '2008924519-nfub56Qt'
const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbyH9GnY0Q2orFoIRxZgU3NzNEeAiQDDQYiwTw814ZFcmMEoBHUXf75mcSM1q25Orgdp/exec'

/* =========================
   å…¨åŸŸç‹€æ…‹
========================= */
let profile = null
const urlParams = new URLSearchParams(location.search)
const token = urlParams.get('token')     // å¯èƒ½ç‚º null
const authMode = token ? 'token' : 'self'

/* =========================
   åˆå§‹åŒ–
========================= */
init()

async function init() {
  log('call liff.init')

  await liff.init({ liffId: LIFF_ID })
  log('liff ready')

  if (!liff.isLoggedIn()) {
    log('redirect login')
    liff.login()
    return
  }

  profile = await liff.getProfile()
  log('got profile')

  // â‘  ç¢ºä¿åç‰‡å­˜åœ¨ï¼ˆåªè¦ userIdï¼‰
  await ensureCard()

  // â‘¡ è¼‰å…¥åç‰‡
  const card = await loadCard()

  // â‘¢ render UI
  render(card)
}

/* =========================
   UI Render
========================= */
function render(card) {
  document.getElementById('app').innerHTML = `
    <img class="avatar" src="${profile.pictureUrl}">
    <div class="small">LINE ä½¿ç”¨è€…ï¼š${profile.displayName}</div>

    <input id="name" placeholder="åç¨±" value="${card.header?.name || ''}">
    <input id="subtitle" placeholder="å‰¯æ¨™" value="${card.header?.subtitle || ''}">
    <input id="image" placeholder="ä¸»åœ– URL" value="${card.hero?.image?.url || ''}">

    <button onclick="save()">ğŸ’¾ å„²å­˜åç‰‡</button>
    <div class="small">å„²å­˜å¾Œå°‡è‡ªå‹•é—œé–‰è¦–çª—</div>
  `
}

/* =========================
   GAS API
========================= */
async function ensureCard() {
  await fetch(GAS_API_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      action: 'createDefaultCard',
      userId: profile.userId,
      displayName: profile.displayName,
      pictureUrl: profile.pictureUrl,
    }),
  })
}

async function loadCard() {
  const res = await fetch(GAS_API_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      action: 'getCardByUserId',
      userId: profile.userId,
    }),
  })

  const data = await res.json()
  return data.card || {}
}

async function save() {
  const card = {
    header: {
      avatarUrl: profile.pictureUrl,
      name: document.getElementById('name').value,
      subtitle: document.getElementById('subtitle').value,
      bgColor: '#1A1B1E',
    },
    hero: {
      mode: 'image',
      image: {
        url: document.getElementById('image').value,
      },
    },
  }

  const payload = {
    action: 'saveCard',
    card,
  }

  // ğŸ” token æ¨¡å¼ï¼ˆå¾ LINE æŒ‡ä»¤é€²ä¾†ï¼‰
  if (authMode === 'token') {
    payload.token = token
  } else {
    // ğŸ‘¤ æœ¬äººæ¨¡å¼ï¼ˆRich Menu / ç›´æ¥é–‹ LIFFï¼‰
    payload.userId = profile.userId
  }

  const res = await fetch(GAS_API_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload),
  })

  const data = await res.json()

  if (!data.ok) {
    alert('âŒ å„²å­˜å¤±æ•—')
    return
  }

  alert('âœ… åç‰‡å·²å„²å­˜ï¼Œè«‹å› LINE è¼¸å…¥ã€Œé¡¯ç¤ºåç‰‡ã€')
  liff.closeWindow()
}

/* =========================
   Log
========================= */
function log(msg) {
  document.getElementById('status').innerText = msg
}
</script>
</body>
</html>
