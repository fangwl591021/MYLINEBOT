<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINEOA æ’ä»¶ç®¡ç†å¹³å°</title>
    <!-- å¼•å…¥ LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f4f7f6; overflow: hidden; }
        .line-green { color: #00B900; }
        .bg-line-green { background-color: #00B900; }
        
        /* å´é‚Šæ¬„æ ¸å¿ƒæ”¶åˆ - æœ€çµ‚å¼·åˆ¶æ¨£å¼ */
        .sidebar-container { 
            background-color: #1e2124; 
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            height: 100vh; display: flex; flex-direction: column; flex-shrink: 0; overflow: hidden; z-index: 50;
        }
        /* å¼·åˆ¶å›ºå®šå¯¬åº¦ */
        .w-expanded { width: 256px !important; min-width: 256px !important; max-width: 256px !important; }
        .w-collapsed { width: 80px !important; min-width: 80px !important; max-width: 80px !important; }

        .sidebar-item-active { background-color: #374151; color: white; border-left: 4px solid #00B900; }
        .submenu-item-active { color: #00B900; font-weight: bold; }
        
        /* æ‰‹æ©Ÿé è¦½æ¨¡æ“¬å™¨ */
        .preview-window { 
            width: 300px; height: 560px; background: #0F0F10; border: 10px solid #333; border-radius: 32px; overflow-y: auto; position: relative; box-shadow: 0 20px 40px -10px rgba(0,0,0,0.5);
        }
        .preview-window::-webkit-scrollbar { width: 0px; }
        
        /* Flex Message é è¦½ */
        .flex-bubble { background: #FFFFFF; border-radius: 12px; overflow: hidden; width: 250px; margin: 0 auto; border: 1px solid #333; }
        .flex-bubble-dark { background: #1F2024; color: white; }
        .flex-badge { position: absolute; top: 10px; right: 10px; color: white; padding: 2px 8px; border-radius: 12px; font-size: 9px; font-weight: bold; z-index: 20; }
        .preview-article { white-space: pre-wrap; word-break: break-all; padding-left: 5px; }

        /* å½±ç‰‡æ’ä»¶å…ƒä»¶ */
        .header-box { background: #1A1B1E; padding: 10px; display: flex; align-items: center; gap: 10px; }
        .video-hero { position: relative; background: #000; width: 100%; aspect-ratio: 800/500; display: flex; align-items: center; justify-content: center; }
        .grid-box { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 10px; background: #0F0F10; }
        .grid-item { background: #2A2C31; padding: 10px; border-radius: 10px; text-align: center; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .rotate-180 { transform: rotate(180deg); }
        .template-aspect { aspect-ratio: 20 / 13; overflow: hidden; background-color: #f1f5f9; }

        input[type="color"] { -webkit-appearance: none; border: none; width: 24px; height: 24px; cursor: pointer; background: none; }
        input[type="color"]::-webkit-color-swatch { border-radius: 4px; border: 1px solid #ddd; }

        .ratio-btn { @apply px-3 py-1 text-xs border border-gray-200 rounded-md transition-all cursor-pointer hover:bg-gray-50 bg-white; }
        .ratio-btn-active { @apply border-line-green bg-green-50 text-line-green font-bold; }
        
        /* å´é‚Šæ¬„æ”¶åˆæ™‚çš„å‹•ç•«æ•ˆæœ */
        .sidebar-transition { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        
        /* å°ˆæ¡ˆå¡ç‰‡ */
        .project-card { 
            background: white; 
            border-radius: 16px; 
            overflow: hidden; 
            transition: all 0.3s ease; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
            border: 1px solid #e5e7eb;
        }
        .project-card:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 12px 24px rgba(0,0,0,0.1); 
            border-color: #00B900;
        }
        
        /* æ¨¡æ…‹è¦–çª— */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        /* è¼‰å…¥å‹•ç•« */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #00B900;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

<div id="app" class="flex h-screen overflow-hidden text-gray-800">
    <!-- å´é‚Šæ¬„ -->
    <aside :class="isSidebarCollapsed ? 'w-collapsed' : 'w-expanded'" class="sidebar-container text-gray-400 shadow-2xl">
        <div class="h-16 flex items-center border-b border-gray-700 overflow-hidden flex-shrink-0 sidebar-transition" 
             :class="isSidebarCollapsed ? 'justify-center px-0' : 'px-6 justify-start'">
            <i class="fab fa-line text-3xl line-green"></i>
            <span v-if="!isSidebarCollapsed" class="text-white text-xl font-bold ml-4 tracking-tighter whitespace-nowrap uppercase font-mono opacity-0 transition-opacity duration-300" 
                  :class="{'opacity-100': !isSidebarCollapsed}">
                LINEOA PLUG
            </span>
        </div>
        
        <nav class="mt-6 flex-grow overflow-y-auto no-scrollbar whitespace-nowrap">
            <a href="#" @click="switchTab('dashboard')" 
               :class="{'sidebar-item-active': currentTab === 'dashboard'}" 
               class="flex items-center py-4 hover:bg-gray-700 transition-colors sidebar-transition"
               :style="isSidebarCollapsed ? 'justify-content: center; padding-left: 0; padding-right: 0;' : 'padding-left: 1.5rem; padding-right: 1.5rem;'">
                <i class="fas fa-chart-pie w-8 text-lg text-center flex-shrink-0"></i>
                <span v-if="!isSidebarCollapsed" class="ml-2 font-medium opacity-0 transition-opacity duration-300"
                      :class="{'opacity-100': !isSidebarCollapsed}">
                    å„€è¡¨æ¿ç¸½è¦½
                </span>
            </a>

            <div>
                <button @click="toggleSidebarMenu" 
                        :class="{'text-white': currentTab === 'messages'}"
                        class="w-full flex items-center py-4 hover:bg-gray-700 focus:outline-none overflow-hidden sidebar-transition"
                        :style="isSidebarCollapsed ? 'justify-content: center; padding-left: 0; padding-right: 0;' : 'padding-left: 1.5rem; padding-right: 1.5rem;'">
                    <i class="fas fa-layer-group w-8 text-lg text-center flex-shrink-0"></i>
                    <template v-if="!isSidebarCollapsed">
                        <span class="ml-2 font-medium opacity-0 transition-opacity duration-300"
                              :class="{'opacity-100': !isSidebarCollapsed}">
                            æ’ä»¶é–‹ç™¼ç®¡ç†
                        </span>
                        <i class="fas fa-chevron-down text-[10px] ml-auto transition-transform sidebar-transition"
                           :class="{'rotate-180': isMessageMenuOpen, 'opacity-0': isSidebarCollapsed, 'opacity-100': !isSidebarCollapsed}"></i>
                    </template>
                </button>
                
                <div v-if="isMessageMenuOpen && !isSidebarCollapsed" class="bg-black bg-opacity-20 py-2 sidebar-transition">
                    <a href="#" @click="switchSubTab('messages', 'single')" 
                       :class="{'submenu-item-active': currentSubTab === 'single'}" 
                       class="flex items-center pl-16 py-2.5 text-sm hover:text-white transition-colors sidebar-transition">
                        å–®é æ–‡ç«  Flex
                    </a>
                    <a href="#" @click="switchSubTab('messages', 'video')" 
                       :class="{'submenu-item-active': currentSubTab === 'video'}" 
                       class="flex items-center pl-16 py-2.5 text-sm hover:text-white transition-colors sidebar-transition">
                        å½±ç‰‡åç‰‡æ’ä»¶
                    </a>
                </div>
            </div>

            <a href="#" @click="switchTab('templates')" 
               :class="{'sidebar-item-active': currentTab === 'templates'}"
               class="flex items-center py-4 hover:bg-gray-700 mt-2 sidebar-transition"
               :style="isSidebarCollapsed ? 'justify-content: center; padding-left: 0; padding-right: 0;' : 'padding-left: 1.5rem; padding-right: 1.5rem;'">
                <i class="fas fa-folder-open w-8 text-lg text-center flex-shrink-0"></i>
                <span v-if="!isSidebarCollapsed" class="ml-2 font-medium opacity-0 transition-opacity duration-300"
                      :class="{'opacity-100': !isSidebarCollapsed}">
                    æ’ä»¶æ¨¡æ¿åº«
                </span>
            </a>

            <a href="#" @click="switchTab('projects')" 
               :class="{'sidebar-item-active': currentTab === 'projects'}"
               class="flex items-center py-4 hover:bg-gray-700 mt-2 sidebar-transition"
               :style="isSidebarCollapsed ? 'justify-content: center; padding-left: 0; padding-right: 0;' : 'padding-left: 1.5rem; padding-right: 1.5rem;'">
                <i class="fas fa-box w-8 text-lg text-center flex-shrink-0"></i>
                <span v-if="!isSidebarCollapsed" class="ml-2 font-medium opacity-0 transition-opacity duration-300"
                      :class="{'opacity-100': !isSidebarCollapsed}">
                    å°ˆæ¡ˆç®¡ç†
                </span>
            </a>
        </nav>
        
        <button @click="isSidebarCollapsed = !isSidebarCollapsed" 
                class="p-4 w-full flex items-center justify-center border-t border-gray-700 hover:text-white transition-colors text-gray-500 bg-gray-900 bg-opacity-30 sidebar-transition">
            <i class="fas sidebar-transition" :class="isSidebarCollapsed ? 'fa-indent text-xl' : 'fa-outdent text-xl'"></i>
            <span v-if="!isSidebarCollapsed" class="ml-3 text-xs font-bold uppercase tracking-widest opacity-0 transition-opacity duration-300"
                  :class="{'opacity-100': !isSidebarCollapsed}">
                æ”¶åˆå·¦å´æ¬„
            </span>
        </button>
    </aside>

    <!-- ä¸»è¦å…§å®¹å€ -->
    <main class="flex-grow flex flex-col h-full relative overflow-hidden bg-[#f8fafc]">
        <header class="h-16 bg-white border-b flex items-center justify-between px-8 flex-shrink-0 shadow-sm z-10">
            <h2 class="text-xl font-bold text-gray-800">{{ pageTitle }}</h2>
            <div class="flex items-center gap-4">
                <div v-if="isLoggedIn" class="flex items-center gap-2 px-4 py-1.5 bg-green-50 rounded-full border border-green-100 shadow-sm">
                    <div class="w-2.5 h-2.5 rounded-full bg-green-500 shadow-[0_0_8px_rgba(0,185,0,0.6)]"></div>
                    <span class="text-[10px] text-green-700 font-bold uppercase">LINE Connected</span>
                </div>
                <div v-else @click="liffLogin" class="flex items-center gap-2 px-4 py-1.5 bg-yellow-50 rounded-full border border-yellow-200 text-yellow-700 text-xs font-bold cursor-pointer hover:bg-yellow-100">
                    <i class="fas fa-sign-in-alt"></i> {{ isInIframe ? 'æ–°åˆ†é ç™»å…¥' : 'ç™»å…¥ LINE' }}
                </div>
                <div class="w-10 h-10 rounded-xl bg-line-green text-white flex items-center justify-center font-bold shadow-md">T</div>
            </div>
        </header>

        <div class="flex-grow overflow-hidden flex">
            <!-- ç·¨è¼¯èˆ‡é è¦½å€ -->
            <div v-if="currentTab === 'messages'" class="flex w-full overflow-hidden">
                <div class="flex-grow overflow-y-auto p-8 bg-white shadow-inner border-r no-scrollbar">
                    <div class="max-w-4xl mx-auto">
                        <div class="flex items-center justify-between mb-8">
                            <div>
                                <h3 class="text-2xl font-bold text-gray-800">{{ flexData.type === 'video' ? 'å½±ç‰‡åç‰‡é–‹ç™¼' : 'æ–‡ç« å‹ Flex é–‹ç™¼' }}</h3>
                                <p class="text-sm text-gray-400 mt-1">ç·¨è¼¯åƒæ•¸å¾Œï¼Œå¯å„²å­˜ç‚ºå°ˆæ¡ˆæˆ–ç›´æ¥æ¨æ’­è‡³ LINEã€‚</p>
                            </div>
                            <div class="flex gap-2">
                                <button v-if="currentProjectId" @click="saveProject(true)" :disabled="isSaving" class="px-6 py-2.5 bg-purple-500 text-white rounded-xl text-sm font-bold shadow-lg hover:opacity-90 disabled:bg-gray-300 flex items-center gap-2">
                                    <i class="fas fa-save"></i> æ›´æ–°å°ˆæ¡ˆ
                                </button>
                                <button v-else @click="showNewProjectModal = true" :disabled="isSaving" class="px-6 py-2.5 bg-purple-500 text-white rounded-xl text-sm font-bold shadow-lg hover:opacity-90 disabled:bg-gray-300 flex items-center gap-2">
                                    <i class="fas fa-plus"></i> å„²å­˜ç‚ºæ–°å°ˆæ¡ˆ
                                </button>
                                <button @click="shareToLine" class="px-6 py-2.5 bg-blue-500 text-white rounded-xl text-sm font-bold shadow-lg hover:opacity-90 flex items-center gap-2">
                                    <i class="fas fa-paper-plane"></i> ğŸš€ æ¨æ’­åˆ†äº«
                                </button>
                                <button @click="saveToGAS" :disabled="isSaving" class="px-6 py-2.5 bg-line-green text-white rounded-xl text-sm font-bold shadow-lg hover:opacity-90 disabled:bg-gray-300">
                                    {{ isSaving ? 'åŒæ­¥ä¸­...' : 'å„²å­˜åˆ°é›²ç«¯' }}
                                </button>
                            </div>
                        </div>

                        <div v-if="currentProjectId" class="mb-6 p-4 bg-purple-50 rounded-xl border border-purple-100">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <i class="fas fa-box text-purple-500"></i>
                                    <div>
                                        <div class="font-bold text-gray-800">{{ currentProjectName }}</div>
                                        <div class="text-xs text-gray-500">å°ˆæ¡ˆID: {{ currentProjectId }}</div>
                                    </div>
                                </div>
                                <button @click="clearCurrentProject" class="text-sm text-gray-500 hover:text-red-500">
                                    <i class="fas fa-times"></i> æ¸…é™¤é¸æ“‡
                                </button>
                            </div>
                        </div>

                        <!-- ç·¨è¼¯å™¨å…§å®¹ -->
                        <div v-if="flexData.type === 'standard'" class="space-y-6">
                            <div class="bg-[#f8fafc] p-6 rounded-2xl border border-gray-100 shadow-sm">
                                <h4 class="text-sm font-bold text-gray-700 mb-4 flex items-center"><i class="fas fa-image mr-2 text-line-green"></i> è¦–è¦ºå…§å®¹è¨­å®š</h4>
                                <div class="space-y-4">
                                    <input type="text" v-model="flexData.imageUrl" class="w-full px-4 py-2 border rounded-xl text-sm focus:border-line-green shadow-sm" placeholder="åœ–ç‰‡ç¶²å€">
                                    <div class="flex items-center gap-3 mt-3">
                                        <button v-for="ratio in ['1:1', '20:13', '4:6']" @click="flexData.aspectRatio = ratio" :class="flexData.aspectRatio === ratio ? 'ratio-btn-active' : ''" class="ratio-btn shadow-sm">{{ ratio }}</button>
                                    </div>
                                    <input type="text" v-model="flexData.title" class="w-full px-4 py-2 border border-gray-200 rounded-xl text-sm focus:border-line-green shadow-sm" placeholder="è¼¸å…¥å¤§æ¨™é¡Œ">
                                    <textarea v-model="flexData.subtitle" rows="6" class="w-full px-4 py-3 border rounded-xl text-sm outline-none leading-relaxed focus:border-line-green shadow-sm" placeholder="è¼¸å…¥æ–‡ç« å…§å®¹..."></textarea>
                                </div>
                            </div>
                            <div class="bg-[#f8fafc] p-6 rounded-2xl border border-gray-100 mt-6 shadow-sm">
                                <h4 class="text-sm font-bold text-gray-700 mb-4 flex justify-between items-center">
                                    <span><i class="fas fa-mouse-pointer mr-2 text-line-green"></i> åº•éƒ¨è¡Œç‚ºæŒ‰éˆ•è¨­å®š</span>
                                </h4>
                                <div class="space-y-3">
                                    <div v-for="(btn, index) in flexData.buttons" :key="index" class="flex gap-3 items-center group bg-white p-3 rounded-xl border transition-all hover:border-green-100 shadow-sm">
                                        <input type="color" v-model="btn.color">
                                        <input type="text" v-model="btn.label" maxlength="10" class="w-32 px-4 py-2 border rounded-lg text-sm" placeholder="æ–‡å­—">
                                        <input type="text" v-model="btn.uri" class="flex-grow px-4 py-2 border rounded-lg text-sm" placeholder="ç¶²å€">
                                        <button @click="removeButton(index)" class="p-2 text-gray-300 hover:text-red-500 transition-colors"><i class="fas fa-trash-alt"></i></button>
                                    </div>
                                    <button v-if="flexData.buttons.length < 3" @click="addButton" class="w-full py-3 mt-2 border-2 border-dashed border-gray-200 rounded-2xl text-sm text-gray-400 bg-white font-bold hover:border-line-green transition-all">+ æ–°å¢åŠŸèƒ½æŒ‰éˆ•</button>
                                </div>
                            </div>
                        </div>

                        <div v-if="flexData.type === 'video'" class="space-y-6">
                            <div class="bg-[#f8fafc] p-6 rounded-2xl border border-gray-100 shadow-sm">
                                <h4 class="text-sm font-bold text-gray-700 mb-4 flex items-center"><i class="fas fa-id-card mr-2 text-line-green"></i> å½±ç‰‡èˆ‡åç‰‡ Header è¨­å®š</h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <input type="text" v-model="flexData.headerName" class="px-4 py-2 border rounded-lg text-sm focus:border-line-green outline-none shadow-sm" placeholder="å“ç‰Œå§“å">
                                    <input type="text" v-model="flexData.headerTitle" class="px-4 py-2 border rounded-lg text-sm focus:border-line-green outline-none shadow-sm" placeholder="è·ä½/ç¨±è™Ÿ">
                                    <input type="text" v-model="flexData.videoUrl" class="col-span-2 px-4 py-2 border rounded-lg text-sm focus:border-line-green outline-none shadow-sm" placeholder="å½±ç‰‡ MP4 é€£çµ">
                                    <div class="col-span-2">
                                        <input type="text" v-model="flexData.previewUrl" class="w-full px-4 py-2 border rounded-lg text-sm focus:border-line-green outline-none shadow-sm" placeholder="å½±ç‰‡é è¦½åœ– (Preview URL)">
                                    </div>
                                </div>
                            </div>
                            <div class="bg-[#f8fafc] p-6 rounded-2xl border border-gray-100 shadow-sm">
                                <h4 class="text-sm font-bold text-gray-700 mb-4 flex items-center"><i class="fas fa-th mr-2 text-line-green"></i> ç¶²æ ¼æŒ‰éˆ•è¨­å®š</h4>
                                <div class="space-y-3">
                                    <div v-for="(grid, index) in flexData.gridButtons" :key="index" class="grid grid-cols-2 gap-3">
                                        <div class="flex items-center gap-2">
                                            <input type="text" v-model="grid.emoji" class="w-16 px-3 py-2 border rounded-lg text-sm" placeholder="emoji">
                                            <input type="text" v-model="grid.label" class="flex-1 px-3 py-2 border rounded-lg text-sm" placeholder="æ¨™ç±¤æ–‡å­—">
                                        </div>
                                        <input type="text" v-model="grid.uri" class="px-3 py-2 border rounded-lg text-sm" placeholder="URL">
                                    </div>
                                </div>
                            </div>
                            <div class="bg-[#f8fafc] p-6 rounded-2xl border border-gray-100 shadow-sm">
                                <h4 class="text-sm font-bold text-gray-700 mb-4 flex items-center"><i class="fas fa-mouse-pointer mr-2 text-line-green"></i> å½±ç‰‡åº•éƒ¨ä¸»æŒ‰éˆ•è¨­å®š</h4>
                                <div class="space-y-3">
                                    <div v-for="(vBtn, vIdx) in flexData.videoFooterButtons" :key="vIdx" class="bg-white p-3 rounded-xl border flex gap-3 shadow-sm items-center transition-all hover:border-blue-100">
                                        <div v-if="vIdx === 0" class="flex flex-col items-center gap-1">
                                            <span class="text-[9px] text-gray-400 font-bold">ä¸»è‰²</span>
                                            <input type="color" v-model="vBtn.color">
                                        </div>
                                        <input type="text" v-model="vBtn.label" class="w-40 border rounded px-3 py-2 text-sm focus:border-blue-300 outline-none" placeholder="æ–‡å­—">
                                        <input type="text" v-model="vBtn.uri" class="flex-grow border rounded px-3 py-2 text-sm focus:border-blue-300 outline-none" placeholder="URL">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- JSON è¼¸å‡º -->
                        <div class="mt-12 mb-20">
                            <div class="flex items-center justify-between mb-3 px-2">
                                <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest"><i class="fas fa-code mr-2"></i>Raw Flex JSON Data</span>
                                <button @click="copyJson" class="text-[10px] text-line-green font-bold hover:underline uppercase">Copy JSON</button>
                            </div>
                            <div class="bg-[#1e2124] rounded-2xl p-6 border border-gray-700 shadow-xl overflow-hidden">
                                <pre class="text-[11px] text-green-400 font-mono leading-relaxed h-48 overflow-y-auto no-scrollbar">{{ generatedJson }}</pre>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å³å´ï¼šæ‰‹æ©Ÿé è¦½å€ -->
                <div class="w-[360px] flex-shrink-0 bg-gray-50 flex items-center justify-center py-8 shadow-inner overflow-y-auto no-scrollbar">
                    <div class="flex flex-col items-center gap-4">
                        <div class="preview-window no-scrollbar shadow-2xl">
                            <div class="p-3 border-b border-gray-800 bg-[#1A1B1E] flex items-center gap-2 sticky top-0 z-50">
                                <i class="fas fa-chevron-left text-gray-600 text-xs"></i>
                                <span class="text-[9px] font-bold text-gray-500 uppercase tracking-tighter">LINE Preview</span>
                            </div>

                            <div v-if="flexData.type === 'standard'" class="p-4">
                                <div class="flex-bubble shadow-xl relative overflow-hidden">
                                    <div class="relative">
                                        <img :src="flexData.imageUrl" :style="{ aspectRatio: flexData.aspectRatio.replace(':', '/') }" class="w-full object-cover transition-all" onerror="this.src='https://via.placeholder.com/250x160?text=Image'">
                                        <div class="flex-badge shadow-md" v-if="flexData.showBadge" :style="{ backgroundColor: flexData.badgeColor }">åˆ†äº«</div>
                                    </div>
                                    <div class="p-4 text-center">
                                        <div class="text-base font-bold truncate">{{ flexData.title || 'æ¨™é¡Œ' }}</div>
                                        <div class="text-[10px] text-gray-500 preview-article mt-2">{{ flexData.subtitle || 'å…§å®¹å€...' }}</div>
                                    </div>
                                    <div class="p-3 pt-0 space-y-1.5">
                                        <button v-for="btn in flexData.buttons" class="w-full py-1.5 text-white text-[10px] font-bold rounded shadow-sm" :style="{ backgroundColor: btn.color }">{{ btn.label }}</button>
                                    </div>
                                </div>
                            </div>

                            <div v-if="flexData.type === 'video'" class="p-4">
                                <div class="flex-bubble flex-bubble-dark shadow-2xl border-gray-800 overflow-hidden">
                                    <div class="header-box">
                                        <img :src="flexData.headerImg" class="w-10 h-10 rounded-full object-cover border border-gray-700">
                                        <span class="text-[11px] font-bold truncate uppercase" style="color:#D4AF37">{{flexData.headerName || 'å§“å'}}</span>
                                    </div>
                                    <div class="video-hero">
                                        <img :src="flexData.previewUrl" class="w-full h-full object-cover opacity-60">
                                        <div class="absolute inset-0 flex items-center justify-center"><i class="fas fa-play-circle text-white text-4xl opacity-90 drop-shadow-lg"></i></div>
                                    </div>
                                    <div class="grid-box">
                                        <div v-for="(grid, gIdx) in flexData.gridButtons" :key="gIdx" class="grid-item">
                                            <div class="text-xl mb-1">{{grid.emoji}}</div>
                                            <div class="text-[8px] text-gray-300 font-bold truncate uppercase tracking-tighter">{{grid.label || 'Grid'}}</div>
                                        </div>
                                    </div>
                                    <div class="p-3 pt-0 space-y-2 bg-[#0F0F10]">
                                        <button v-for="(vBtn, vI) in flexData.videoFooterButtons" :key="vI" 
                                                class="w-full py-2 text-[10px] font-bold rounded shadow-md transition-all active:scale-95"
                                                :style="vI === 0 ? { backgroundColor: vBtn.color, color: '#fff' } : { backgroundColor: '#2A2C31', color: '#999' }">
                                            {{vBtn.label || 'æŒ‰éˆ•'}}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æ’ä»¶æ¨¡æ¿åº« -->
            <div v-if="currentTab === 'templates'" class="w-full overflow-y-auto p-8">
                <div class="max-w-7xl mx-auto">
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">æ’ä»¶æ¨¡æ¿åº«</h3>
                    <p class="text-gray-500 mb-8">é¸æ“‡æ¨¡æ¿å¿«é€Ÿé–‹å§‹ä½ çš„æ’ä»¶è¨­è¨ˆ</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div v-for="(template, idx) in templates" :key="idx" 
                             @click="applyTemplate(template)"
                             class="bg-white rounded-2xl overflow-hidden shadow-lg hover:shadow-2xl transition-all duration-300 hover:-translate-y-1 cursor-pointer group">
                            <div class="template-aspect overflow-hidden bg-gray-100">
                                <img :src="template.thumbnail" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105">
                            </div>
                            <div class="p-5">
                                <div class="flex items-center justify-between mb-2">
                                    <h4 class="font-bold text-gray-800">{{ template.name }}</h4>
                                    <span class="px-2 py-1 text-xs rounded-full" :class="template.type === 'video' ? 'bg-purple-100 text-purple-700' : 'bg-green-100 text-green-700'">
                                        {{ template.type === 'video' ? 'å½±ç‰‡å‹' : 'æ–‡ç« å‹' }}
                                    </span>
                                </div>
                                <p class="text-sm text-gray-500 mb-4">é»æ“Šç«‹å³å¥—ç”¨æ¨¡æ¿</p>
                                <button class="w-full py-2.5 bg-line-green text-white rounded-xl text-sm font-bold hover:opacity-90 transition-all">
                                    ç«‹å³å¥—ç”¨
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å°ˆæ¡ˆç®¡ç†é é¢ -->
            <div v-if="currentTab === 'projects'" class="w-full overflow-y-auto p-8">
                <div class="max-w-7xl mx-auto">
                    <div class="flex items-center justify-between mb-8">
                        <div>
                            <h3 class="text-2xl font-bold text-gray-800 mb-2">å°ˆæ¡ˆç®¡ç†</h3>
                            <p class="text-gray-500">ç®¡ç†æ‚¨çš„æ’ä»¶è¨­è¨ˆå°ˆæ¡ˆï¼Œå¯ä»¥å„²å­˜ã€ç·¨è¼¯å’Œåˆªé™¤</p>
                        </div>
                        <button @click="showNewProjectModal = true" 
                                class="px-6 py-3 bg-line-green text-white rounded-xl text-sm font-bold shadow-lg hover:opacity-90 flex items-center gap-2">
                            <i class="fas fa-plus"></i> æ–°å¢å°ˆæ¡ˆ
                        </button>
                    </div>
                    
                    <!-- å°ˆæ¡ˆç¯©é¸å™¨ -->
                    <div class="mb-6 p-4 bg-white rounded-xl border shadow-sm">
                        <div class="flex items-center gap-4">
                            <div class="flex-1">
                                <input type="text" v-model="projectSearch" 
                                       placeholder="æœå°‹å°ˆæ¡ˆåç¨±æˆ–é¡å‹..." 
                                       class="w-full px-4 py-2 border rounded-lg focus:border-line-green outline-none">
                            </div>
                            <div class="flex gap-2">
                                <button @click="loadProjects" class="px-4 py-2 bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100">
                                    <i class="fas fa-sync-alt"></i> é‡æ–°æ•´ç†
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- è¼‰å…¥ä¸­ç‹€æ…‹ -->
                    <div v-if="loadingProjects" class="text-center py-12">
                        <div class="spinner mx-auto mb-4"></div>
                        <p class="text-gray-500">è¼‰å…¥å°ˆæ¡ˆä¸­...</p>
                    </div>
                    
                    <!-- å°ˆæ¡ˆåˆ—è¡¨ -->
                    <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div v-for="project in filteredProjects" :key="project.id" 
                             class="project-card">
                            <div class="p-5">
                                <div class="flex items-start justify-between mb-3">
                                    <div>
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="px-2 py-1 text-xs rounded-full" 
                                                  :class="project.type === 'video' ? 'bg-purple-100 text-purple-700' : 'bg-green-100 text-green-700'">
                                                {{ project.type === 'video' ? 'å½±ç‰‡å‹' : 'æ–‡ç« å‹' }}
                                            </span>
                                            <span class="text-xs text-gray-500">{{ formatDate(project.created_at) }}</span>
                                        </div>
                                        <h4 class="font-bold text-lg text-gray-800">{{ project.name }}</h4>
                                        <p class="text-sm text-gray-500 mt-1">{{ project.description || 'æœªæ·»åŠ æè¿°' }}</p>
                                    </div>
                                    <button @click="deleteProject(project.id)" 
                                            class="text-gray-400 hover:text-red-500 transition-colors">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                                
                                <div class="mt-4 flex gap-2">
                                    <button @click="loadProject(project)" 
                                            class="flex-1 py-2 bg-line-green text-white rounded-lg text-sm font-bold hover:opacity-90">
                                        <i class="fas fa-edit"></i> ç·¨è¼¯
                                    </button>
                                    <button @click="shareProject(project)" 
                                            class="flex-1 py-2 bg-blue-500 text-white rounded-lg text-sm font-bold hover:opacity-90">
                                        <i class="fas fa-paper-plane"></i> æ¨æ’­
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ç„¡å°ˆæ¡ˆæ™‚çš„æç¤º -->
                    <div v-if="!loadingProjects && projects.length === 0" class="text-center py-16">
                        <i class="fas fa-box-open text-5xl text-gray-300 mb-4"></i>
                        <h4 class="text-xl font-bold text-gray-500 mb-2">å°šç„¡å°ˆæ¡ˆ</h4>
                        <p class="text-gray-400 mb-6">é–‹å§‹å‰µå»ºæ‚¨çš„ç¬¬ä¸€å€‹æ’ä»¶å°ˆæ¡ˆå§ï¼</p>
                        <button @click="showNewProjectModal = true" 
                                class="px-6 py-3 bg-line-green text-white rounded-xl text-sm font-bold shadow-lg hover:opacity-90">
                            å‰µå»ºç¬¬ä¸€å€‹å°ˆæ¡ˆ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- æ–°å¢å°ˆæ¡ˆæ¨¡æ…‹è¦–çª— -->
    <div v-if="showNewProjectModal" class="modal-overlay" @click.self="showNewProjectModal = false">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-800">å„²å­˜ç‚ºæ–°å°ˆæ¡ˆ</h3>
                <button @click="showNewProjectModal = false" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">å°ˆæ¡ˆåç¨± *</label>
                    <input type="text" v-model="newProject.name" 
                           class="w-full px-4 py-2 border rounded-lg focus:border-line-green outline-none"
                           placeholder="ä¾‹å¦‚ï¼šç”¢å“ä»‹ç´¹å¡ç‰‡">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">å°ˆæ¡ˆæè¿°</label>
                    <textarea v-model="newProject.description" rows="3"
                              class="w-full px-4 py-2 border rounded-lg focus:border-line-green outline-none"
                              placeholder="æè¿°æ­¤å°ˆæ¡ˆçš„ç”¨é€”å’Œå…§å®¹"></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">å°ˆæ¡ˆé¡å‹</label>
                    <div class="flex gap-2">
                        <button @click="newProject.type = 'standard'" 
                                :class="newProject.type === 'standard' ? 'bg-green-100 text-green-700 border-green-300' : 'bg-gray-100 text-gray-700'"
                                class="flex-1 py-2 border rounded-lg text-sm font-medium">
                            æ–‡ç« å‹
                        </button>
                        <button @click="newProject.type = 'video'" 
                                :class="newProject.type === 'video' ? 'bg-purple-100 text-purple-700 border-purple-300' : 'bg-gray-100 text-gray-700'"
                                class="flex-1 py-2 border rounded-lg text-sm font-medium">
                            å½±ç‰‡å‹
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="mt-8 flex gap-3">
                <button @click="showNewProjectModal = false" 
                        class="flex-1 py-3 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50">
                    å–æ¶ˆ
                </button>
                <button @click="saveProject(false)" 
                        :disabled="!newProject.name || isSaving"
                        class="flex-1 py-3 bg-line-green text-white rounded-lg font-bold hover:opacity-90 disabled:bg-gray-300">
                    {{ isSaving ? 'å„²å­˜ä¸­...' : 'å„²å­˜å°ˆæ¡ˆ' }}
                </button>
            </div>
        </div>
    </div>
    
    <!-- åˆªé™¤ç¢ºèªæ¨¡æ…‹è¦–çª— -->
    <div v-if="showDeleteConfirm" class="modal-overlay" @click.self="showDeleteConfirm = false">
        <div class="modal-content">
            <div class="text-center">
                <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                <h3 class="text-xl font-bold text-gray-800 mb-2">ç¢ºèªåˆªé™¤</h3>
                <p class="text-gray-600 mb-6">æ‚¨ç¢ºå®šè¦åˆªé™¤æ­¤å°ˆæ¡ˆå—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚</p>
                
                <div class="flex gap-3">
                    <button @click="showDeleteConfirm = false" 
                            class="flex-1 py-3 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50">
                        å–æ¶ˆ
                    </button>
                    <button @click="confirmDelete" 
                            class="flex-1 py-3 bg-red-500 text-white rounded-lg font-bold hover:opacity-90">
                        ç¢ºèªåˆªé™¤
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, computed, onMounted } = Vue;

    // --- è¨­å®šå€ ---
    const GAS_API_URL = "https://script.google.com/macros/s/YOUR_DEPLOYED_SCRIPT_ID/exec"; // æ›¿æ›ç‚ºæ‚¨çš„ GAS éƒ¨ç½²ç¶²å€
    const DEFAULT_SPREADSHEET_ID = "1qQjIMf8WDAuklmqz_sqfQoDysttMETJqcy69mdkqXyM";
    const LINE_CHANNEL_ACCESS_TOKEN = "YOUR_LINE_CHANNEL_ACCESS_TOKEN"; // æ›¿æ›ç‚ºæ‚¨çš„ LINE Channel Access Token

    createApp({
        setup() {
            // ç‹€æ…‹è®Šæ•¸
            const isSidebarCollapsed = ref(false);
            const isMessageMenuOpen = ref(true);
            const currentTab = ref('messages');
            const currentSubTab = ref('single');
            const isSaving = ref(false);
            const isLoggedIn = ref(false);
            const isInIframe = ref(false);
            const liffProfile = ref(null);
            
            // å°ˆæ¡ˆç›¸é—œç‹€æ…‹
            const showNewProjectModal = ref(false);
            const showDeleteConfirm = ref(false);
            const projectSearch = ref('');
            const projects = ref([]);
            const loadingProjects = ref(false);
            const currentProjectId = ref(null);
            const currentProjectName = ref('');
            const projectToDelete = ref(null);
            
            // æ–°å°ˆæ¡ˆè³‡æ–™
            const newProject = ref({
                name: '',
                description: '',
                type: 'standard'
            });

            onMounted(async () => {
                isInIframe.value = window.self !== window.top;
                if (typeof liff !== 'undefined') {
                    try {
                        await liff.init({ liffId: "2008541971-XPIDtaaj" });
                        console.log("LIFF Ready");
                        isLoggedIn.value = liff.isLoggedIn();
                        
                        if (isLoggedIn.value) {
                            liffProfile.value = await liff.getProfile();
                        }
                    } catch (err) {
                        console.error("LIFF Init failed", err);
                    }
                }
                // è¼‰å…¥å°ˆæ¡ˆåˆ—è¡¨
                loadProjects();
            });

            // åˆå§‹åŒ–æ•¸æ“š
            const flexData = ref({
                type: 'standard', 
                imageUrl: 'https://scdn.line-apps.com/n/channel_devcenter/img/fx/01_1_cafe.png',
                aspectRatio: '20:13', 
                title: 'Brown Cafe', 
                subtitle: 'æ­¡è¿å…‰è‡¨ï¼æ”¯æ´é•·æ–‡æ›è¡Œã€‚', 
                showBadge: true, 
                badgeColor: '#FF0000',
                buttons: [{ label: 'äº†è§£æ›´å¤š', uri: 'https://example.com', color: '#00B900' }],
                
                // å½±ç‰‡æ¨¡æ¿æ•¸æ“š
                headerImg: 'https://aiwe.cc/wp-content/uploads/2025/04/f9ebd0672d3b0ac370272909a493d4db.png',
                headerName: 'TONY', 
                headerTitle: 'LINEè¡ŒéŠ·é”äºº',
                headerDescription: 'ç³»çµ±é–‹ç™¼',
                videoUrl: 'https://voom-obs.line-scdn.net/ho1sEMNWDLB8UUD8RLAYrZjJoJzAxV3cPGT8MeBQ_J2YzD3JIGgELJDl3bm4xeSUUJy9_IhBjCiYfajYJIBEMORdaCXUceRQXDigUOQpZHg/mp4',
                previewUrl: 'https://voom-obs.line-scdn.net/ho1sEMNWDLB8UUD8RLAYrZjJoJzAxV3cPGT8MeBQ_J2YzD3JIGgELJDl3bm4xeSUUJy9_IhBjCiYfajYJIBEMORdaCXUceRQXDigUOQpZHg/m800x1200',
                gridButtons: [
                    { emoji: 'ğŸ¤–', label: 'AI è«®è©¢', uri: 'https://liff.line.me/2006625044-bPGxrB53/' },
                    { emoji: 'ğŸ¥', label: 'ç”¢å“ä»‹ç´¹', uri: 'https://example.com/video' },
                    { emoji: 'ğŸ§¾', label: 'å•†å“å‹éŒ„', uri: 'https://example.com/catalog' },
                    { emoji: 'ğŸ“', label: 'é–€å¸‚è³‡è¨Š', uri: 'https://example.com/map' }
                ],
                videoFooterButtons: [
                    { label: 'ğŸš€ å•Ÿå‹• AI å°å¹«æ‰‹', uri: 'https://liff.line.me/2006625044-bPGxrB53/index.php/colt_sp/6502/', color: '#C9A24D' },
                    { label: 'ğŸ“¤ åˆ†äº«å¥½å‹', uri: 'https://liff.line.me/2006625044-J42EzjkZ/index.php/linecard_12/6816/' }
                ]
            });

            const templates = ref([
                { 
                    name: 'æ–‡ç« å‹æ¨¡æ¿', 
                    type: 'standard', 
                    thumbnail: 'https://scdn.line-apps.com/n/channel_devcenter/img/fx/01_1_cafe.png', 
                    payload: { 
                        type:'standard', 
                        imageUrl:'https://scdn.line-apps.com/n/channel_devcenter/img/fx/01_1_cafe.png', 
                        aspectRatio:'20:13', 
                        title:'ç¶“å…¸å’–å•¡', 
                        subtitle:'æ”¯æ´æ›è¡Œã€‚', 
                        showBadge:true, 
                        badgeColor:'#FF0000', 
                        buttons:[{label:'äº†è§£æ›´å¤š', uri:'#', color:'#00B900'}]
                    } 
                },
                { 
                    name: 'å½±ç‰‡åç‰‡æ¨¡æ¿', 
                    type: 'video', 
                    thumbnail: 'https://aiwe.cc/wp-content/uploads/2025/04/f9ebd0672d3b0ac370272909a493d4db.png', 
                    payload: { 
                        type:'video', 
                        headerName:'TONY', 
                        headerTitle: 'LINEè¡ŒéŠ·é”äºº',
                        headerDescription: 'ç³»çµ±é–‹ç™¼',
                        headerImg:'https://aiwe.cc/wp-content/uploads/2025/04/f9ebd0672d3b0ac370272909a493d4db.png', 
                        videoUrl:'https://voom-obs.line-scdn.net/ho1sEMNWDLB8UUD8RLAYrZjJoJzAxV3cPGT8MeBQ_J2YzD3JIGgELJDl3bm4xeSUUJy9_IhBjCiYfajYJIBEMORdaCXUceRQXDigUOQpZHg/mp4',
                        previewUrl:'https://voom-obs.line-scdn.net/ho1sEMNWDLB8UUD8RLAYrZjJoJzAxV3cPGT8MeBQ_J2YzD3JIGgELJDl3bm4xeSUUJy9_IhBjCiYfajYJIBEMORdaCXUceRQXDigUOQpZHg/m800x1200',
                        gridButtons: [
                            {emoji:'ğŸ¤–',label:'AI è«®è©¢',uri:'https://liff.line.me/2006625044-bPGxrB53/'},
                            {emoji:'ğŸ¥',label:'ç”¢å“ä»‹ç´¹',uri:'https://example.com/video'},
                            {emoji:'ğŸ§¾',label:'å•†å“å‹éŒ„',uri:'https://example.com/catalog'},
                            {emoji:'ğŸ“',label:'é–€å¸‚è³‡è¨Š',uri:'https://example.com/map'}
                        ], 
                        videoFooterButtons:[
                            {label:'ğŸš€ å•Ÿå‹• AI å°å¹«æ‰‹',uri:'https://liff.line.me/2006625044-bPGxrB53/index.php/colt_sp/6502/',color:'#C9A24D'},
                            {label:'ğŸ“¤ åˆ†äº«å¥½å‹',uri:'https://liff.line.me/2006625044-J42EzjkZ/index.php/linecard_12/6816/'}
                        ]
                    } 
                }
            ]);

            // è¨ˆç®—å±¬æ€§
            const pageTitle = computed(() => {
                const titles = {
                    'dashboard': 'å„€è¡¨æ¿ç¸½è¦½',
                    'messages': 'æ’ä»¶é–‹ç™¼ç®¡ç†å¹³å°',
                    'templates': 'æ’ä»¶æ¨¡æ¿é¸æ“‡ä¸­å¿ƒ',
                    'projects': 'å°ˆæ¡ˆç®¡ç†'
                };
                return titles[currentTab.value] || 'LINEOA æ’ä»¶ç®¡ç†å¹³å°';
            });
            
            const filteredProjects = computed(() => {
                if (!projectSearch.value) return projects.value;
                const search = projectSearch.value.toLowerCase();
                return projects.value.filter(project => 
                    project.name.toLowerCase().includes(search) ||
                    project.type.toLowerCase().includes(search) ||
                    (project.description && project.description.toLowerCase().includes(search))
                );
            });

            const generatedJson = computed(() => {
                if (flexData.value.type === 'standard') {
                    const contents = [
                        { 
                            type: "image", 
                            url: flexData.value.imageUrl, 
                            size: "full", 
                            aspectRatio: flexData.value.aspectRatio, 
                            animated: true 
                        }, 
                        { 
                            type: "text", 
                            text: flexData.value.title, 
                            weight: "bold", 
                            size: "xl", 
                            align: "center", 
                            margin: "sm" 
                        }, 
                        { 
                            type: "text", 
                            text: flexData.value.subtitle, 
                            size: "sm", 
                            margin: "sm", 
                            offsetStart: "5px", 
                            wrap: true 
                        }
                    ];
                    
                    return { 
                        type: "bubble", 
                        body: { 
                            type: "box", 
                            layout: "vertical", 
                            paddingAll: "0px", 
                            contents: contents 
                        }, 
                        footer: { 
                            type: "box", 
                            layout: "vertical", 
                            spacing: "sm", 
                            contents: flexData.value.buttons.map(b => ({ 
                                type: "button", 
                                style: "primary", 
                                color: b.color, 
                                height: "sm", 
                                action: { 
                                    type: "uri", 
                                    label: b.label, 
                                    uri: b.uri 
                                } 
                            })) 
                        } 
                    };
                } else {
                    return { 
                        type: "bubble",
                        size: "mega",
                        header: {
                            type: "box",
                            layout: "horizontal",
                            spacing: "md",
                            paddingAll: "8px",
                            backgroundColor: "#1A1B1E",
                            contents: [
                                {
                                    type: "image",
                                    url: flexData.value.headerImg,
                                    size: "xs",
                                    aspectRatio: "1:1",
                                    aspectMode: "cover",
                                    gravity: "center"
                                },
                                {
                                    type: "box",
                                    layout: "vertical",
                                    spacing: "xs",
                                    flex: 3,
                                    contents: [
                                        {
                                            type: "text",
                                            text: flexData.value.headerName || "TONY",
                                            weight: "bold",
                                            size: "lg",
                                            color: "#D4AF37"
                                        },
                                        {
                                            type: "text",
                                            text: flexData.value.headerTitle || "LINEè¡ŒéŠ·é”äºº",
                                            size: "sm",
                                            color: "#E6E6E6"
                                        },
                                        {
                                            type: "text",
                                            text: flexData.value.headerDescription || "ç³»çµ±é–‹ç™¼",
                                            size: "xs",
                                            color: "#A0A0A0",
                                            wrap: true
                                        }
                                    ]
                                }
                            ]
                        },
                        hero: {
                            type: "video",
                            url: flexData.value.videoUrl,
                            previewUrl: flexData.value.previewUrl,
                            aspectRatio: "800:500",
                            altContent: {
                                type: "image",
                                url: flexData.value.previewUrl,
                                size: "full",
                                aspectRatio: "800:500",
                                aspectMode: "cover"
                            }
                        },
                        body: {
                            type: "box",
                            layout: "vertical",
                            paddingAll: "8px",
                            contents: [
                                {
                                    type: "box",
                                    layout: "vertical",
                                    spacing: "sm",
                                    paddingAll: "12px",
                                    backgroundColor: "#1F2024",
                                    cornerRadius: "14px",
                                    contents: [
                                        {
                                            type: "box",
                                            layout: "horizontal",
                                            spacing: "sm",
                                            contents: [
                                                {
                                                    type: "box",
                                                    layout: "vertical",
                                                    paddingAll: "12px",
                                                    backgroundColor: "#2A2C31",
                                                    cornerRadius: "12px",
                                                    action: {
                                                        type: "uri",
                                                        label: flexData.value.gridButtons[0]?.label || "AI è«®è©¢",
                                                        uri: flexData.value.gridButtons[0]?.uri || "#"
                                                    },
                                                    contents: [
                                                        {
                                                            type: "text",
                                                            text: flexData.value.gridButtons[0]?.emoji || "ğŸ¤–",
                                                            size: "xl",
                                                            align: "center"
                                                        },
                                                        {
                                                            type: "text",
                                                            text: flexData.value.gridButtons[0]?.label || "AI è«®è©¢",
                                                            size: "sm",
                                                            align: "center",
                                                            color: "#E6E6E6"
                                                        }
                                                    ]
                                                },
                                                {
                                                    type: "box",
                                                    layout: "vertical",
                                                    paddingAll: "12px",
                                                    backgroundColor: "#2A2C31",
                                                    cornerRadius: "12px",
                                                    action: {
                                                        type: "uri",
                                                        label: flexData.value.gridButtons[1]?.label || "ç”¢å“ä»‹ç´¹",
                                                        uri: flexData.value.gridButtons[1]?.uri || "#"
                                                    },
                                                    contents: [
                                                        {
                                                            type: "text",
                                                            text: flexData.value.gridButtons[1]?.emoji || "ğŸ¥",
                                                            size: "xl",
                                                            align: "center"
                                                        },
                                                        {
                                                            type: "text",
                                                            text: flexData.value.gridButtons[1]?.label || "ç”¢å“ä»‹ç´¹",
                                                            size: "sm",
                                                            align: "center",
                                                            color: "#E6E6E6"
                                                        }
                                                    ]
                                                }
                                            ]
                                        },
                                        {
                                            type: "box",
                                            layout: "horizontal",
                                            spacing: "sm",
                                            contents: [
                                                {
                                                    type: "box",
                                                    layout: "vertical",
                                                    paddingAll: "12px",
                                                    backgroundColor: "#2A2C31",
                                                    cornerRadius: "12px",
                                                    action: {
                                                        type: "uri",
                                                        label: flexData.value.gridButtons[2]?.label || "å•†å“å‹éŒ„",
                                                        uri: flexData.value.gridButtons[2]?.uri || "#"
                                                    },
                                                    contents: [
                                                        {
                                                            type: "text",
                                                            text: flexData.value.gridButtons[2]?.emoji || "ğŸ§¾",
                                                            size: "xl",
                                                            align: "center"
                                                        },
                                                        {
                                                            type: "text",
                                                            text: flexData.value.gridButtons[2]?.label || "å•†å“å‹éŒ„",
                                                            size: "sm",
                                                            align: "center",
                                                            color: "#E6E6E6"
                                                        }
                                                    ]
                                                },
                                                {
                                                    type: "box",
                                                    layout: "vertical",
                                                    paddingAll: "12px",
                                                    backgroundColor: "#2A2C31",
                                                    cornerRadius: "12px",
                                                    action: {
                                                        type: "uri",
                                                        label: flexData.value.gridButtons[3]?.label || "é–€å¸‚è³‡è¨Š",
                                                        uri: flexData.value.gridButtons[3]?.uri || "#"
                                                    },
                                                    contents: [
                                                        {
                                                            type: "text",
                                                            text: flexData.value.gridButtons[3]?.emoji || "ğŸ“",
                                                            size: "xl",
                                                            align: "center"
                                                        },
                                                        {
                                                            type: "text",
                                                            text: flexData.value.gridButtons[3]?.label || "é–€å¸‚è³‡è¨Š",
                                                            size: "sm",
                                                            align: "center",
                                                            color: "#E6E6E6"
                                                        }
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        },
                        footer: {
                            type: "box",
                            layout: "vertical",
                            spacing: "sm",
                            paddingAll: "8px",
                            contents: [
                                {
                                    type: "button",
                                    style: "primary",
                                    color: flexData.value.videoFooterButtons[0]?.color || "#C9A24D",
                                    height: "sm",
                                    action: {
                                        type: "uri",
                                        label: flexData.value.videoFooterButtons[0]?.label || "ğŸš€ å•Ÿå‹• AI å°å¹«æ‰‹",
                                        uri: flexData.value.videoFooterButtons[0]?.uri || "#"
                                    }
                                },
                                {
                                    type: "button",
                                    style: "secondary",
                                    height: "sm",
                                    action: {
                                        type: "uri",
                                        label: flexData.value.videoFooterButtons[1]?.label || "ğŸ“¤ åˆ†äº«å¥½å‹",
                                        uri: flexData.value.videoFooterButtons[1]?.uri || "#"
                                    }
                                }
                            ]
                        },
                        styles: {
                            body: {
                                backgroundColor: "#0F0F10"
                            },
                            footer: {
                                backgroundColor: "#0F0F10"
                            }
                        }
                    };
                }
            });

            // æ–¹æ³•
            const switchTab = (t) => {
                currentTab.value = t;
                if (t === 'projects') {
                    loadProjects();
                }
            };
            
            const toggleSidebarMenu = () => { 
                if (isSidebarCollapsed.value) {
                    isSidebarCollapsed.value = false;
                    setTimeout(() => {
                        isMessageMenuOpen.value = true;
                    }, 100);
                } else {
                    isMessageMenuOpen.value = !isMessageMenuOpen.value;
                }
            };
            
            const switchSubTab = (t, s) => { 
                currentTab.value = t; 
                currentSubTab.value = s; 
                flexData.value.type = (s === 'video' ? 'video' : 'standard'); 
            };
            
            const applyTemplate = (tpl) => { 
                flexData.value = JSON.parse(JSON.stringify(tpl.payload)); 
                currentTab.value = 'messages'; 
                currentSubTab.value = (tpl.type === 'video' ? 'video' : 'single'); 
            };
            
            const addButton = () => { 
                if (flexData.value.buttons.length < 3) {
                    flexData.value.buttons.push({ 
                        label: 'æ–°æŒ‰éˆ•', 
                        uri: 'https://example.com', 
                        color: '#00B900' 
                    }); 
                }
            };
            
            const removeButton = (idx) => flexData.value.buttons.splice(idx, 1);
            
            const copyJson = () => { 
                const el = document.createElement('textarea'); 
                el.value = JSON.stringify(generatedJson.value, null, 2); 
                document.body.appendChild(el); 
                el.select(); 
                document.execCommand('copy'); 
                document.body.removeChild(el); 
                alert('JSON å·²è¤‡è£½ï¼'); 
            };

            const liffLogin = () => {
                if (isInIframe.value) window.open("https://liff.line.me/2008541971-XPIDtaaj", "_blank");
                else liff.login();
            };

            // ç›´æ¥æ¨æ’­ï¼ˆä½¿ç”¨ LIFF shareTargetPickerï¼‰
            const shareToLine = () => {
                if (!liff.isLoggedIn()) { 
                    alert("è«‹å…ˆç™»å…¥ LINEã€‚"); 
                    liffLogin(); 
                    return; 
                }
                liff.shareTargetPicker([{ 
                    type: "flex", 
                    altText: "åˆ†äº«å®¢è£½åŒ–æ’ä»¶è¨Šæ¯", 
                    contents: generatedJson.value 
                }])
                .then(res => { 
                    if (res) alert("ç™¼é€æˆåŠŸï¼"); 
                })
                .catch(err => alert("ç™¼é€å¤±æ•—ï¼š" + err));
            };

            // å„²å­˜åˆ° GASï¼ˆåŒ…å«æ¨æ’­åŠŸèƒ½ï¼‰
            const saveToGAS = async () => {
                if (!liffProfile.value) {
                    alert("è«‹å…ˆç™»å…¥ LINE");
                    liffLogin();
                    return;
                }

                isSaving.value = true;
                try {
                    const payload = {
                        action: 'savePlugin',
                        spreadsheetId: DEFAULT_SPREADSHEET_ID,
                        accessToken: LINE_CHANNEL_ACCESS_TOKEN,
                        userId: liffProfile.value.userId,
                        type: flexData.value.type,
                        name: flexData.value.title || flexData.value.headerName || 'æœªå‘½åå°ˆæ¡ˆ',
                        params: flexData.value,
                        flexPayload: {
                            type: 'flex',
                            altText: 'LINEOA æ’ä»¶è¨Šæ¯',
                            contents: generatedJson.value
                        }
                    };

                    const response = await fetch(GAS_API_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    });

                    alert('æ•¸æ“šå·²å„²å­˜åˆ° Google Sheetsï¼');
                    
                } catch (error) {
                    console.error('å„²å­˜å¤±æ•—:', error);
                    alert('å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°');
                } finally {
                    isSaving.value = false;
                }
            };

            // è¼‰å…¥å°ˆæ¡ˆåˆ—è¡¨
            const loadProjects = async () => {
                loadingProjects.value = true;
                try {
                    const response = await fetch(`${GAS_API_URL}?action=getProjects&spreadsheetId=${DEFAULT_SPREADSHEET_ID}`);
                    const data = await response.json();
                    if (data.success) {
                        projects.value = data.projects;
                    } else {
                        console.error('è¼‰å…¥å°ˆæ¡ˆå¤±æ•—:', data.message);
                        projects.value = [];
                    }
                } catch (error) {
                    console.error('è¼‰å…¥å°ˆæ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                    projects.value = [];
                } finally {
                    loadingProjects.value = false;
                }
            };

            // å„²å­˜å°ˆæ¡ˆ
            const saveProject = async (isUpdate = false) => {
                if (!newProject.value.name && !isUpdate) {
                    alert('è«‹è¼¸å…¥å°ˆæ¡ˆåç¨±');
                    return;
                }

                isSaving.value = true;
                try {
                    const payload = {
                        action: isUpdate ? 'updateProject' : 'createProject',
                        spreadsheetId: DEFAULT_SPREADSHEET_ID,
                        name: isUpdate ? currentProjectName.value : newProject.value.name,
                        description: newProject.value.description,
                        type: flexData.value.type,
                        data: JSON.stringify(flexData.value),
                        flex_json: JSON.stringify(generatedJson.value)
                    };

                    if (isUpdate) {
                        payload.id = currentProjectId.value;
                    }

                    const response = await fetch(GAS_API_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    });

                    alert(isUpdate ? 'å°ˆæ¡ˆæ›´æ–°æˆåŠŸï¼' : 'å°ˆæ¡ˆå„²å­˜æˆåŠŸï¼');
                    
                    if (!isUpdate) {
                        currentProjectId.value = Date.now().toString(); // è‡¨æ™‚ ID
                        currentProjectName.value = newProject.value.name;
                        showNewProjectModal.value = false;
                        newProject.value = {
                            name: '',
                            description: '',
                            type: 'standard'
                        };
                    }
                    
                    loadProjects();
                    switchTab('projects');
                } catch (error) {
                    console.error('å„²å­˜å°ˆæ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                    alert('å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                } finally {
                    isSaving.value = false;
                }
            };

            // è¼‰å…¥å°ˆæ¡ˆ
            const loadProject = (project) => {
                try {
                    if (project.data) {
                        const projectData = typeof project.data === 'string' ? 
                            JSON.parse(project.data) : project.data;
                        
                        flexData.value = projectData;
                        currentProjectId.value = project.id;
                        currentProjectName.value = project.name;
                        
                        currentTab.value = 'messages';
                        currentSubTab.value = project.type === 'video' ? 'video' : 'single';
                        
                        alert(`å·²è¼‰å…¥å°ˆæ¡ˆ: ${project.name}`);
                    }
                } catch (error) {
                    console.error('è¼‰å…¥å°ˆæ¡ˆè³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                    alert('è¼‰å…¥å°ˆæ¡ˆå¤±æ•—');
                }
            };

            // åˆªé™¤å°ˆæ¡ˆ
            const deleteProject = (projectId) => {
                projectToDelete.value = projectId;
                showDeleteConfirm.value = true;
            };

            const confirmDelete = async () => {
                try {
                    const payload = {
                        action: 'deleteProject',
                        spreadsheetId: DEFAULT_SPREADSHEET_ID,
                        id: projectToDelete.value
                    };

                    await fetch(GAS_API_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    });

                    alert('å°ˆæ¡ˆåˆªé™¤æˆåŠŸï¼');
                    
                    if (currentProjectId.value === projectToDelete.value) {
                        clearCurrentProject();
                    }
                    
                    loadProjects();
                } catch (error) {
                    console.error('åˆªé™¤å°ˆæ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                    alert('åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                } finally {
                    showDeleteConfirm.value = false;
                    projectToDelete.value = null;
                }
            };

            // æ¸…é™¤ç•¶å‰å°ˆæ¡ˆ
            const clearCurrentProject = () => {
                currentProjectId.value = null;
                currentProjectName.value = '';
                flexData.value = {
                    type: 'standard', 
                    imageUrl: 'https://scdn.line-apps.com/n/channel_devcenter/img/fx/01_1_cafe.png',
                    aspectRatio: '20:13', 
                    title: '', 
                    subtitle: '', 
                    showBadge: true, 
                    badgeColor: '#FF0000',
                    buttons: [{ label: 'äº†è§£æ›´å¤š', uri: 'https://example.com', color: '#00B900' }]
                };
            };

            // æ¨æ’­å°ˆæ¡ˆ
            const shareProject = async (project) => {
                if (!liffProfile.value) {
                    alert("è«‹å…ˆç™»å…¥ LINE");
                    liffLogin();
                    return;
                }

                try {
                    const payload = {
                        action: 'pushProject',
                        spreadsheetId: DEFAULT_SPREADSHEET_ID,
                        accessToken: LINE_CHANNEL_ACCESS_TOKEN,
                        id: project.id,
                        userId: liffProfile.value.userId
                    };

                    const response = await fetch(GAS_API_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    });

                    alert('å°ˆæ¡ˆæ¨æ’­è«‹æ±‚å·²ç™¼é€ï¼');
                } catch (error) {
                    console.error('æ¨æ’­å°ˆæ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                    alert('æ¨æ’­å¤±æ•—');
                }
            };

            // æ ¼å¼åŒ–æ—¥æœŸ
            const formatDate = (dateString) => {
                if (!dateString) return 'ç„¡æ—¥æœŸ';
                try {
                    const date = new Date(dateString);
                    return date.toLocaleDateString('zh-TW', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                } catch (e) {
                    return 'æ—¥æœŸæ ¼å¼éŒ¯èª¤';
                }
            };

            return { 
                isSidebarCollapsed, 
                isMessageMenuOpen, 
                currentTab, 
                currentSubTab, 
                flexData, 
                templates, 
                projects,
                projectSearch,
                loadingProjects,
                newProject,
                currentProjectId,
                currentProjectName,
                showNewProjectModal,
                showDeleteConfirm,
                pageTitle, 
                generatedJson, 
                filteredProjects,
                isSaving, 
                isLoggedIn, 
                isInIframe, 
                liffLogin, 
                switchTab, 
                toggleSidebarMenu, 
                switchSubTab, 
                applyTemplate, 
                addButton, 
                removeButton, 
                copyJson, 
                saveToGAS, 
                shareToLine,
                loadProjects,
                saveProject,
                loadProject,
                deleteProject,
                confirmDelete,
                clearCurrentProject,
                shareProject,
                formatDate
            }
        }
    }).mount('#app');
</script>
</body>
</html>
