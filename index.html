<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE OA 專業管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        :root {
            --line-green: #06C755;
            --line-dark-green: #05b34c;
            --sidebar-bg: #2b303b;
            --main-bg: #f8fafc;
        }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--main-bg); color: #1e293b; overflow: hidden; }
        
        /* 介面框架 */
        .sidebar { width: 240px; background-color: var(--sidebar-bg); color: #ffffff; shrink: 0; }
        .sidebar-item { padding: 12px 20px; display: flex; align-items: center; gap: 12px; transition: 0.2s; color: #94a3b8; cursor: pointer; border-left: 4px solid transparent; }
        .sidebar-item:hover { background-color: #3e4451; color: #ffffff; }
        .sidebar-item.active { background-color: #3e4451; color: #ffffff; border-left-color: var(--line-green); }
        .header { height: 60px; background: white; border-bottom: 1px solid #e2e8f0; padding: 0 24px; display: flex; align-items: center; justify-content: space-between; }
        
        /* 管理表格 */
        .data-table { width: 100%; background: white; border-collapse: collapse; border-radius: 12px; overflow: hidden; }
        .data-table th { text-align: left; background: #f1f5f9; padding: 14px 20px; font-size: 13px; color: #64748b; font-weight: 700; }
        .data-table td { padding: 16px 20px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
        
        /* 狀態標籤 */
        .badge { padding: 4px 10px; border-radius: 99px; font-size: 11px; font-weight: 700; }
        .badge-green { background: #dcfce7; color: #166534; }

        /* 預覽容器 */
        .chat-room-bg { background-color: #7988a0; height: 100%; overflow-y: auto; padding: 40px 20px; display: flex; flex-direction: column; align-items: center; }
        .carousel-wrapper { display: flex; gap: 16px; padding-bottom: 20px; max-width: 100%; overflow-x: auto; scroll-snap-type: x mandatory; }
        .flex-bubble-container { width: 300px; shrink-0; border-radius: 18px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2); background: white; scroll-snap-align: center; position: relative; }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .icon { width: 18px; height: 18px; stroke-width: 2; stroke: currentColor; fill: none; stroke-linecap: round; stroke-linejoin: round; }
    </style>
</head>
<body class="h-screen flex">

    <!-- 圖示定義區 -->
    <svg style="display: none;">
        <symbol id="icon-home" viewBox="0 0 24 24"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></symbol>
        <symbol id="icon-layers" viewBox="0 0 24 24"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></symbol>
        <symbol id="icon-plus" viewBox="0 0 24 24"><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></symbol>
        <symbol id="icon-trash" viewBox="0 0 24 24"><path d="M3 6h18m-2 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></symbol>
        <symbol id="icon-play" viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"/></symbol>
        <symbol id="icon-copy" viewBox="0 0 24 24"><rect width="13" height="13" x="9" y="9" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></symbol>
        <symbol id="icon-edit" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></symbol>
        <symbol id="icon-chevron-right" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></symbol>
        <symbol id="icon-x" viewBox="0 0 24 24"><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></symbol>
        <symbol id="icon-alert" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></symbol>
    </svg>

    <!-- 側邊欄 -->
    <aside class="sidebar h-full flex flex-col z-30 shadow-2xl">
        <div class="p-6 mb-4">
            <div class="flex items-center gap-3 bg-white/10 p-3 rounded-xl border border-white/10">
                <div class="bg-line-green p-1.5 rounded-lg text-white"><svg class="icon"><use href="#icon-home"/></svg></div>
                <span class="font-bold text-base">OA 管理系統</span>
            </div>
        </div>
        <nav class="flex-1">
            <div class="sidebar-item active" id="menu-dashboard" onclick="exitEditor()"><svg class="icon"><use href="#icon-home"/></svg> 儀表板首頁</div>
            <div class="sidebar-item" id="menu-modules" onclick="enterEditor()"><svg class="icon"><use href="#icon-layers"/></svg> 訊息模組庫</div>
        </nav>
        <div class="p-4 bg-black/20 text-[10px] text-gray-500 text-center font-bold uppercase">Hybrid Engine v5.1</div>
    </aside>

    <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Header -->
        <header class="header shrink-0 shadow-sm z-20">
            <div id="header-nav" class="flex items-center gap-2 text-sm text-slate-400">
                <span class="cursor-pointer hover:text-slate-600" onclick="exitEditor()">後台首頁</span>
                <div id="editor-breadcrumb" class="hidden flex items-center gap-2">
                    <svg class="icon w-3 h-3"><use href="#icon-chevron-right"/></svg>
                    <span class="text-slate-900 font-bold">模組訓練編輯器</span>
                </div>
            </div>
            <div id="editor-actions" class="hidden flex gap-3">
                <button onclick="exitEditor()" class="px-4 py-2 text-xs font-bold text-slate-500">放棄變更</button>
                <button onclick="exportJSON()" class="bg-slate-900 text-white px-4 py-2 rounded-lg text-xs font-bold flex items-center gap-2 hover:bg-black transition">
                    <svg class="icon w-3.5 h-3.5"><use href="#icon-copy"/></svg> 複製 JSON
                </button>
            </div>
        </header>

        <!-- 視圖 1：儀表板 -->
        <main id="view-dashboard" class="flex-1 overflow-y-auto p-8 custom-scrollbar">
            <div class="max-w-6xl mx-auto">
                <div class="flex justify-between items-end mb-8">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">模組訓練總覽</h2>
                        <p class="text-slate-400 text-sm mt-1">建立並管理單頁或多頁輪播 Flex Message。</p>
                    </div>
                    <button onclick="enterEditor()" class="bg-line-green text-white px-6 py-2.5 rounded-xl font-bold shadow-lg hover:bg-line-dark-green transition flex items-center gap-2">
                        <svg class="icon w-5 h-5"><use href="#icon-plus"/></svg> 建立新訓練模組
                    </button>
                </div>
                <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                    <table class="data-table">
                        <thead>
                            <tr><th>模組名稱</th><th>型態</th><th>分頁</th><th>最後更新</th><th>操作</th></tr>
                        </thead>
                        <tbody id="module-list-body">
                            <tr>
                                <td class="font-bold">新品推廣組合包</td>
                                <td><span class="badge badge-green">混合多頁</span></td>
                                <td class="text-slate-500">2 頁</td>
                                <td class="text-slate-400 text-xs">2025/01/18 20:00</td>
                                <td><button onclick="enterEditor()" class="text-slate-400 hover:text-line-green"><svg class="icon"><use href="#icon-edit"/></svg></button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>

        <!-- 視圖 2：完整編輯器 -->
        <main id="view-editor" class="flex-1 hidden overflow-hidden flex">
            <!-- 左側屬性面板 -->
            <aside class="w-[450px] bg-white border-r border-slate-200 overflow-y-auto p-6 space-y-8 custom-scrollbar shadow-inner">
                
                <!-- 輪播頁面管理 -->
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest">分頁導覽</h3>
                        <div id="add-page-wrapper">
                            <button onclick="addCard()" id="btn-add-page" class="text-[10px] font-bold text-line-green border border-line-green px-3 py-1 rounded-lg hover:bg-line-green hover:text-white transition disabled:opacity-30 disabled:hover:bg-transparent disabled:hover:text-line-green">+ 增加卡片</button>
                        </div>
                    </div>
                    <div id="card-nav" class="flex gap-2 overflow-x-auto pb-4 custom-scrollbar"></div>
                    <p id="video-warning" class="hidden text-[10px] text-red-500 font-bold bg-red-50 p-2 rounded border border-red-100 flex items-center gap-1">
                        <svg class="icon w-3 h-3"><use href="#icon-alert"/></svg> 影片模型不支援多頁輪播，請刪除多餘分頁。
                    </p>
                </div>

                <div class="h-px bg-slate-100"></div>

                <!-- 範本切換 -->
                <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200 shadow-sm">
                    <label class="input-label text-line-green">設定此分頁模型範本</label>
                    <select id="select-card-type" onchange="changeCardType(this.value)" class="w-full text-sm font-bold p-2.5 bg-white border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-line-green/20">
                        <option value="GRID">商品網格模型 (支援 3-4 欄)</option>
                        <option value="BANNER">宣傳大圖模型 (1:1 比例)</option>
                        <option value="VIDEO" id="opt-video">影片播放模型 (僅支援單頁)</option>
                        <option value="NOTICE">純文字通知模型</option>
                    </select>
                </div>

                <!-- 視覺設定 (Hero) -->
                <section id="section-hero" class="space-y-4">
                    <h4 class="text-xs font-bold text-slate-800 flex items-center gap-2">視覺組件設定 (Hero)</h4>
                    <div class="space-y-3">
                        <input type="text" id="in-hero-url" oninput="updateActiveCard('heroUrl', this.value)" class="input-field" placeholder="主素材網址">
                        <div id="box-video-poster">
                            <label class="input-label">影片封面預覽圖 (JPG)</label>
                            <input type="text" id="in-video-poster" oninput="updateActiveCard('videoPoster', this.value)" class="input-field">
                        </div>
                    </div>
                </section>

                <!-- 內容設定 (Body) -->
                <section id="section-body" class="space-y-4">
                    <div class="flex justify-between items-center">
                        <h4 class="text-xs font-bold text-slate-800">資料項目列表</h4>
                        <div class="flex items-center gap-2">
                            <input type="color" id="in-tag-color" onchange="updateActiveCard('tagColor', this.value)" class="w-5 h-5 border-none p-0 cursor-pointer">
                            <select id="in-cols" onchange="updateActiveCard('columns', parseInt(this.value))" class="text-[10px] border rounded">
                                <option value="3">3 欄</option><option value="4">4 欄</option>
                            </select>
                        </div>
                    </div>
                    <div id="items-list" class="space-y-3"></div>
                    <button onclick="addItem()" class="w-full py-3 border-2 border-dashed border-slate-300 rounded-2xl text-slate-400 text-xs font-bold hover:border-line-green hover:text-line-green transition">+ 新增資料項目</button>
                </section>

                <!-- 按鈕設定 (Footer) -->
                <section class="space-y-4 pb-10">
                    <h4 class="text-xs font-bold text-slate-800">底部操作按鈕</h4>
                    <div class="space-y-3">
                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200 space-y-2 shadow-sm">
                            <div class="flex justify-between items-center"><span class="text-[10px] font-bold text-slate-400">按鈕 1</span><input type="color" id="in-f1-color" onchange="updateActiveCard('btn1Color', this.value)" class="w-4 h-4 p-0 border-none cursor-pointer"></div>
                            <input type="text" id="in-f1-label" oninput="updateActiveCard('btn1Label', this.value)" class="input-field" placeholder="名稱">
                            <input type="text" id="in-f1-url" oninput="updateActiveCard('btn1Url', this.value)" class="w-full text-[10px] p-2 border rounded-lg outline-none" placeholder="連結">
                        </div>
                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200 space-y-2 shadow-sm">
                            <div class="flex justify-between items-center"><span class="text-[10px] font-bold text-slate-400">按鈕 2</span><input type="color" id="in-f2-color" onchange="updateActiveCard('btn2Color', this.value)" class="w-4 h-4 p-0 border-none cursor-pointer"></div>
                            <input type="text" id="in-f2-label" oninput="updateActiveCard('btn2Label', this.value)" class="input-field" placeholder="名稱">
                            <input type="text" id="in-f2-url" oninput="updateActiveCard('btn2Url', this.value)" class="w-full text-[10px] p-2 border rounded-lg outline-none" placeholder="連結">
                        </div>
                    </div>
                </section>
            </aside>

            <!-- 右側即時預覽 -->
            <section class="flex-1 chat-room-bg custom-scrollbar relative">
                <div class="flex items-start gap-4 w-full max-w-full px-12 mt-12 mb-20">
                    <div class="w-10 h-10 rounded-full bg-slate-400 shrink-0 shadow-lg border-2 border-white/20"></div>
                    <div class="carousel-wrapper custom-scrollbar" id="preview-area"></div>
                </div>
            </section>
        </main>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-12 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-10 py-4 rounded-full shadow-2xl opacity-0 transition-all pointer-events-none z-50 transform translate-y-4 font-bold">JSON 已複製到剪貼簿</div>

    <script>
        const SAMPLES = {
            image: "https://lihi.cc/5OXMZ",
            video: "https://lihi.cc/YsmAp",
            p1: "https://lihi.cc/mwMvo",
            p2: "https://lihi.cc/2Nu8G",
            p3: "https://lihi.cc/yRfpn"
        };

        let cards = [];
        let activeIdx = 0;

        function createNewCard(type = 'GRID') {
            return {
                type: type,
                heroUrl: (type === 'VIDEO') ? SAMPLES.video : SAMPLES.image,
                videoPoster: SAMPLES.image,
                columns: 3,
                tagColor: "#0D0D0D",
                items: [
                    { title: "精品咖啡", img: SAMPLES.p1, url: "https://line.me" },
                    { title: "手作甜點", img: SAMPLES.p2, url: "https://line.me" }
                ],
                btn1Label: "查看詳情", btn1Color: "#111111", btn1Url: "https://line.me",
                btn2Label: "領取優惠", btn2Color: "#06C755", btn2Url: "https://line.me"
            };
        }

        // --- 視圖控制 ---
        function enterEditor() {
            cards = [createNewCard('GRID')];
            activeIdx = 0;
            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('view-editor').classList.remove('hidden');
            document.getElementById('editor-actions').classList.remove('hidden');
            document.getElementById('editor-breadcrumb').classList.remove('hidden');
            syncUI(); renderPreview();
        }

        function exitEditor() {
            document.getElementById('view-dashboard').classList.remove('hidden');
            document.getElementById('view-editor').classList.add('hidden');
            document.getElementById('editor-actions').classList.add('hidden');
            document.getElementById('editor-breadcrumb').classList.add('hidden');
        }

        // --- 核心操作 ---
        function addCard() {
            if(cards.length >= 12 || cards[0].type === 'VIDEO') return;
            cards.push(createNewCard('GRID'));
            activeIdx = cards.length - 1;
            syncUI(); renderPreview();
        }

        function deleteCard(idx) {
            if (cards.length <= 1) return;
            cards.splice(idx, 1);
            if (activeIdx >= cards.length) activeIdx = cards.length - 1;
            syncUI(); renderPreview();
        }

        function changeCardType(type) {
            cards[activeIdx].type = type;
            if(type === 'VIDEO') cards[activeIdx].heroUrl = SAMPLES.video;
            syncUI(); renderPreview();
        }

        function updateActiveCard(key, val) {
            cards[activeIdx][key] = val;
            renderPreview();
        }

        function addItem() {
            cards[activeIdx].items.push({ title: "新項目", img: SAMPLES.p3, url: "https://line.me" });
            syncUI(); renderPreview();
        }

        function deleteItem(idx) {
            cards[activeIdx].items.splice(idx, 1);
            syncUI(); renderPreview();
        }

        // --- UI 與規範約束 ---
        function syncUI() {
            const cur = cards[activeIdx];
            const isMulti = cards.length > 1;
            const isVideo = cur.type === 'VIDEO';

            // 1. 處理分頁導覽
            const nav = document.getElementById('card-nav');
            nav.innerHTML = cards.map((c, i) => `
                <div class="relative shrink-0">
                    <button onclick="activeIdx=${i};syncUI();renderPreview();" class="px-7 py-3 rounded-2xl text-xs font-bold border-2 transition-all ${i===activeIdx ? 'bg-line-green text-white border-line-green shadow-lg scale-105' : 'bg-white text-slate-400 border-slate-100'}">
                        P${i+1}
                    </button>
                    ${isMulti ? `<button onclick="event.stopPropagation();deleteCard(${i});" class="absolute -top-2 -right-2 w-5 h-5 bg-red-500 text-white rounded-full flex items-center justify-center border-2 border-white shadow-md"><svg class="icon w-2 h-2"><use href="#icon-x"/></svg></button>` : ''}
                </div>
            `).join('');

            // 2. 約束邏輯：多頁時禁用影片，影片時禁用增加分頁
            const addBtn = document.getElementById('btn-add-page');
            const videoOpt = document.getElementById('opt-video');
            const videoWarn = document.getElementById('video-warning');

            addBtn.disabled = isVideo; // 影片不能增加卡片
            videoOpt.disabled = isMulti; // 已有多張卡片時，不能切換為影片
            videoWarn.classList.toggle('hidden', !isVideo);

            // 3. 同步控制項
            document.getElementById('select-card-type').value = cur.type;
            document.getElementById('in-hero-url').value = cur.heroUrl;
            document.getElementById('in-video-poster').value = cur.videoPoster;
            document.getElementById('box-video-poster').classList.toggle('hidden', cur.type !== 'VIDEO');
            document.getElementById('in-cols').value = cur.columns;
            document.getElementById('in-tag-color').value = cur.tagColor;
            document.getElementById('in-f1-label').value = cur.btn1Label;
            document.getElementById('in-f1-color').value = cur.btn1Color;
            document.getElementById('in-f1-url').value = cur.btn1Url;
            document.getElementById('in-f2-label').value = cur.btn2Label;
            document.getElementById('in-f2-color').value = cur.btn2Color;
            document.getElementById('in-f2-url').value = cur.btn2Url;

            // 4. 資料清單
            const list = document.getElementById('items-list');
            list.innerHTML = cur.items.map((item, i) => `
                <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl relative shadow-sm space-y-2">
                    <button onclick="deleteItem(${i})" class="absolute top-2 right-2 text-slate-300 hover:text-red-500"><svg class="icon w-4 h-4"><use href="#icon-trash"/></svg></button>
                    <input type="text" value="${item.title}" oninput="cards[activeIdx].items[${i}].title=this.value;renderPreview();" class="w-full text-xs font-bold p-1 border rounded outline-none" placeholder="項目標題">
                    <input type="text" value="${item.img}" oninput="cards[activeIdx].items[${i}].img=this.value;renderPreview();" class="w-full text-[9px] p-1 border rounded outline-none" placeholder="圖片連結">
                    <input type="text" value="${item.url}" oninput="cards[activeIdx].items[${i}].url=this.value;renderPreview();" class="w-full text-[9px] p-1 border rounded outline-none" placeholder="點擊連結">
                </div>
            `).join('');
            
            document.getElementById('section-hero').style.display = (cur.type === 'NOTICE') ? 'none' : 'block';
            document.getElementById('section-body').style.display = (cur.type === 'BANNER' || cur.type === 'VIDEO') ? 'none' : 'block';
        }

        function renderPreview() {
            const area = document.getElementById('preview-area');
            area.innerHTML = cards.map((c, idx) => {
                let heroHtml = '';
                if(c.type !== 'NOTICE') {
                    const ratio = (c.type === 'BANNER') ? 'aspect-1-1' : 'aspect-16-9';
                    heroHtml = `<div class="relative w-full bg-black overflow-hidden ${ratio}"><img src="${(c.type === 'VIDEO') ? c.videoPoster : c.heroUrl}" class="w-full h-full object-cover">${c.type === 'VIDEO' ? `<div class="absolute inset-0 flex items-center justify-center"><div class="w-12 h-12 bg-white/90 rounded-full flex items-center justify-center shadow-2xl"><svg style="fill:#111" class="icon w-6 h-6 ml-1"><use href="#icon-play"/></svg></div></div>` : ''}</div>`;
                }
                let bodyHtml = '';
                if(c.type === 'GRID' || c.type === 'NOTICE') {
                    bodyHtml = `<div class="p-5 bg-slate-50 border-b"><div class="grid gap-2 grid-cols-${c.columns}">${c.items.map(it => `<div class="bg-white rounded p-1 shadow-sm border border-slate-100 flex flex-col"><div class="aspect-square bg-slate-100 rounded overflow-hidden mb-1"><img src="${it.img}" class="w-full h-full object-cover"></div><div style="background-color:${c.tagColor}; color:#fff" class="text-[8px] font-bold text-center py-1 rounded truncate">${it.title}</div></div>`).join('')}</div></div>`;
                }
                return `<div class="flex-bubble-container border-2 transition-all duration-500 ${idx === activeIdx ? 'border-line-green scale-105 z-10 shadow-2xl' : 'border-transparent opacity-60 scale-95'}">${heroHtml}${bodyHtml}<div class="p-3 flex gap-2 bg-white"><button class="flex-1 py-2.5 rounded-xl text-[10px] font-bold text-white shadow-lg" style="background-color: ${c.btn1Color}">${c.btn1Label}</button><button class="flex-1 py-2.5 rounded-xl text-[10px] font-bold text-white shadow-lg" style="background-color: ${c.btn2Color}">${c.btn2Label}</button></div></div>`;
            }).join('');
            const target = area.children[activeIdx];
            if(target) target.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
        }

        // --- 官方結構 JSON 生成 ---
        function generateFlexJSON() {
            const buildBubble = (c) => {
                const bubble = {
                    type: "bubble",
                    size: "mega",
                    body: { type: "box", layout: "vertical", spacing: "md", contents: [] },
                    footer: { type: "box", layout: "horizontal", spacing: "sm", contents: [
                        { type: "button", style: "primary", color: c.btn1Color, action: { type: "uri", label: c.btn1Label, uri: c.btn1Url } },
                        { type: "button", style: "primary", color: c.btn2Color, action: { type: "uri", label: c.btn2Label, uri: c.btn2Url } }
                    ]}
                };
                if (c.type === 'BANNER') bubble.hero = { type: "image", url: c.heroUrl, size: "full", aspectRatio: "1:1", aspectMode: "cover" };
                else if (c.type === 'VIDEO') bubble.hero = { type: "video", url: c.heroUrl, previewUrl: c.videoPoster, aspectRatio: "16:9", altContent: { type: "image", size: "full", aspectRatio: "16:9", aspectMode: "cover", url: c.videoPoster } };
                else if (c.type === 'GRID') bubble.hero = { type: "image", url: c.heroUrl, size: "full", aspectRatio: "16:9", aspectMode: "cover" };

                if (c.type === 'GRID' || c.type === 'NOTICE') {
                    const chunk = (arr, size) => Array.from({ length: Math.ceil(arr.length / size) }, (v, i) => arr.slice(i * size, i * size + size));
                    bubble.body.contents = chunk(c.items, c.columns).map(row => ({
                        type: "box", layout: "horizontal", spacing: "sm", contents: row.map(it => ({
                            type: "box", layout: "vertical", width: c.columns === 3 ? "32%" : "23%", action: { type: "uri", uri: it.url }, contents: [
                                { type: "image", url: it.img, aspectRatio: "1:1", aspectMode: "cover", size: "full" },
                                { type: "box", layout: "vertical", backgroundColor: c.tagColor, cornerRadius: "sm", paddingAll: "xs", contents: [{ type: "text", text: it.title, color: "#ffffff", size: "xxs", align: "center", weight: "bold", wrap: true }] }
                            ]
                        }))
                    }));
                }
                return bubble;
            };
            return cards.length === 1 ? buildBubble(cards[0]) : { type: "carousel", contents: cards.map(c => buildBubble(c)) };
        }

        function exportJSON() {
            const el = document.createElement('textarea');
            el.value = JSON.stringify(generateFlexJSON(), null, 2);
            document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el);
            const toast = document.getElementById('toast');
            toast.style.opacity = '1'; toast.style.transform = 'translate(-50%, -10px)';
            setTimeout(() => { toast.style.opacity = '0'; toast.style.transform = 'translate(-50%, 16px)'; }, 2500);
        }

        window.onload = () => exitEditor();
    </script>
</body>
</html>
