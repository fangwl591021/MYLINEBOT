
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINEOA æ’ä»¶ç®¡ç†å¹³å°</title>
    <!-- å¼•å…¥ LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f4f7f6; overflow: hidden; }
        .line-green { color: #00B900; }
        .bg-line-green { background-color: #00B900; }
        
        .sidebar-container { 
            background-color: #1e2124; 
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            height: 100vh; display: flex; flex-direction: column; flex-shrink: 0; overflow: hidden; z-index: 50;
        }
        .w-expanded { width: 256px !important; min-width: 256px !important; max-width: 256px !important; }
        .w-collapsed { width: 80px !important; min-width: 80px !important; max-width: 80px !important; }

        .sidebar-item-active { background-color: #374151; color: white; border-left: 4px solid #00B900; }
        .submenu-item-active { color: #00B900; font-weight: bold; }
        
        .preview-window { 
            width: 300px; height: 560px; background: #0F0F10; border: 10px solid #333; border-radius: 32px; overflow-y: auto; position: relative; box-shadow: 0 20px 40px -10px rgba(0,0,0,0.5);
        }
        .preview-window::-webkit-scrollbar { width: 0px; }
        
        .flex-bubble { background: #FFFFFF; border-radius: 12px; overflow: hidden; width: 250px; margin: 0 auto; border: 1px solid #333; }
        .flex-bubble-dark { background: #1F2024; color: white; }
        .flex-badge { position: absolute; top: 10px; right: 10px; color: white; padding: 2px 8px; border-radius: 12px; font-size: 9px; font-weight: bold; z-index: 20; }
        .preview-article { white-space: pre-wrap; word-break: break-all; padding-left: 5px; }

        .header-box { background: #1A1B1E; padding: 10px; display: flex; align-items: center; gap: 10px; }
        .video-hero { position: relative; background: #000; width: 100%; aspect-ratio: 800/500; display: flex; align-items: center; justify-content: center; }
        .grid-box { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 10px; background: #0F0F10; }
        .grid-item { background: #2A2C31; padding: 10px; border-radius: 10px; text-align: center; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .rotate-180 { transform: rotate(180deg); }
        .template-aspect { aspect-ratio: 20 / 13; overflow: hidden; background-color: #f1f5f9; }

        input[type="color"] { -webkit-appearance: none; border: none; width: 24px; height: 24px; cursor: pointer; background: none; }
        input[type="color"]::-webkit-color-swatch { border-radius: 4px; border: 1px solid #ddd; }

        .ratio-btn { @apply px-3 py-1 text-xs border border-gray-200 rounded-md transition-all cursor-pointer hover:bg-gray-50 bg-white; }
        .ratio-btn-active { @apply border-line-green bg-green-50 text-line-green font-bold; }
        
        .sidebar-transition { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        
        .project-card { 
            background: white; 
            border-radius: 16px; 
            overflow: hidden; 
            transition: all 0.3s ease; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
            border: 1px solid #e5e7eb;
        }
        .project-card:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 12px 24px rgba(0,0,0,0.1); 
            border-color: #00B900;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #00B900;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* é›»å­å•†å‹™ç‰ˆå°ˆç”¨æ¨£å¼ */
        .chat-room-bg {
            background-color: #7988a0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .flex-bubble-container {
            width: 100%;
            max-width: 350px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        
        .border-line-green { border-color: #06C755; }
        .text-line-green { color: #06C755; }

        .aspect-1-1 { aspect-ratio: 1 / 1; }
        .aspect-16-9 { aspect-ratio: 16 / 9; }
        .aspect-4-3 { aspect-ratio: 4 / 3; }
        .aspect-1_91-1 { aspect-ratio: 1.91 / 1; }
        .aspect-3-4 { aspect-ratio: 3 / 4; }
    </style>
</head>
<body>

<div id="app" class="flex h-screen overflow-hidden text-gray-800">
    <!-- å´é‚Šæ¬„ -->
    <aside :class="isSidebarCollapsed ? 'w-collapsed' : 'w-expanded'" class="sidebar-container text-gray-400 shadow-2xl">
        <div class="h-16 flex items-center border-b border-gray-700 overflow-hidden flex-shrink-0 sidebar-transition" 
             :class="isSidebarCollapsed ? 'justify-center px-0' : 'px-6 justify-start'">
            <i class="fab fa-line text-3xl line-green"></i>
            <span v-if="!isSidebarCollapsed" class="text-white text-xl font-bold ml-4 tracking-tighter whitespace-nowrap uppercase font-mono opacity-0 transition-opacity duration-300" 
                  :class="{'opacity-100': !isSidebarCollapsed}">
                LINEOA PLUG
            </span>
        </div>
        
        <nav class="mt-6 flex-grow overflow-y-auto no-scrollbar whitespace-nowrap">
            <a href="#" @click="switchTab('dashboard')" 
               :class="{'sidebar-item-active': currentTab === 'dashboard'}" 
               class="flex items-center py-4 hover:bg-gray-700 transition-colors sidebar-transition"
               :style="isSidebarCollapsed ? 'justify-content: center; padding-left: 0; padding-right: 0;' : 'padding-left: 1.5rem; padding-right: 1.5rem;'">
                <i class="fas fa-chart-pie w-8 text-lg text-center flex-shrink-0"></i>
                <span v-if="!isSidebarCollapsed" class="ml-2 font-medium opacity-0 transition-opacity duration-300"
                      :class="{'opacity-100': !isSidebarCollapsed}">
                    å„€è¡¨æ¿ç¸½è¦½
                </span>
            </a>

            <div>
                <button @click="toggleSidebarMenu" 
                        :class="{'text-white': currentTab === 'messages'}"
                        class="w-full flex items-center py-4 hover:bg-gray-700 focus:outline-none overflow-hidden sidebar-transition"
                        :style="isSidebarCollapsed ? 'justify-content: center; padding-left: 0; padding-right: 0;' : 'padding-left: 1.5rem; padding-right: 1.5rem;'">
                    <i class="fas fa-layer-group w-8 text-lg text-center flex-shrink-0"></i>
                    <template v-if="!isSidebarCollapsed">
                        <span class="ml-2 font-medium opacity-0 transition-opacity duration-300"
                              :class="{'opacity-100': !isSidebarCollapsed}">
                            æ’ä»¶é–‹ç™¼ç®¡ç†
                        </span>
                        <i class="fas fa-chevron-down text-[10px] ml-auto transition-transform sidebar-transition"
                           :class="{'rotate-180': isMessageMenuOpen, 'opacity-0': isSidebarCollapsed, 'opacity-100': !isSidebarCollapsed}"></i>
                    </template>
                </button>
                
                <div v-if="isMessageMenuOpen && !isSidebarCollapsed" class="bg-black bg-opacity-20 py-2 sidebar-transition">
                    <a href="#" @click="switchSubTab('messages', 'single')" 
                       :class="{'submenu-item-active': currentSubTab === 'single'}" 
                       class="flex items-center pl-16 py-2.5 text-sm hover:text-white transition-colors sidebar-transition">
                        å–®é æ–‡ç«  Flex
                    </a>
                    <a href="#" @click="switchSubTab('messages', 'video')" 
                       :class="{'submenu-item-active': currentSubTab === 'video'}" 
                       class="flex items-center pl-16 py-2.5 text-sm hover:text-white transition-colors sidebar-transition">
                        å½±ç‰‡åç‰‡æ’ä»¶
                    </a>
                    <a href="#" @click="switchSubTab('messages', 'ecommerce')" 
                       :class="{'submenu-item-active': currentSubTab === 'ecommerce'}" 
                       class="flex items-center pl-16 py-2.5 text-sm hover:text-white transition-colors sidebar-transition">
                        é›»å•†å‹æ’ä»¶
                    </a>
                </div>
            </div>

            <a href="#" @click="switchTab('templates')" 
               :class="{'sidebar-item-active': currentTab === 'templates'}"
               class="flex items-center py-4 hover:bg-gray-700 mt-2 sidebar-transition"
               :style="isSidebarCollapsed ? 'justify-content: center; padding-left: 0; padding-right: 0;' : 'padding-left: 1.5rem; padding-right: 1.5rem;'">
                <i class="fas fa-folder-open w-8 text-lg text-center flex-shrink-0"></i>
                <span v-if="!isSidebarCollapsed" class="ml-2 font-medium opacity-0 transition-opacity duration-300"
                      :class="{'opacity-100': !isSidebarCollapsed}">
                    æ’ä»¶æ¨¡æ¿åº«
                </span>
            </a>

            <a href="#" @click="switchTab('projects')" 
               :class="{'sidebar-item-active': currentTab === 'projects'}"
               class="flex items-center py-4 hover:bg-gray-700 mt-2 sidebar-transition"
               :style="isSidebarCollapsed ? 'justify-content: center; padding-left: 0; padding-right: 0;' : 'padding-left: 1.5rem; padding-right: 1.5rem;'">
                <i class="fas fa-box w-8 text-lg text-center flex-shrink-0"></i>
                <span v-if="!isSidebarCollapsed" class="ml-2 font-medium opacity-0 transition-opacity duration-300"
                      :class="{'opacity-100': !isSidebarCollapsed}">
                    å°ˆæ¡ˆç®¡ç†
                </span>
            </a>
        </nav>
        
        <button @click="isSidebarCollapsed = !isSidebarCollapsed" 
                class="p-4 w-full flex items-center justify-center border-t border-gray-700 hover:text-white transition-colors text-gray-500 bg-gray-900 bg-opacity-30 sidebar-transition">
            <i class="fas sidebar-transition" :class="isSidebarCollapsed ? 'fa-indent text-xl' : 'fa-outdent text-xl'"></i>
            <span v-if="!isSidebarCollapsed" class="ml-3 text-xs font-bold uppercase tracking-widest opacity-0 transition-opacity duration-300"
                  :class="{'opacity-100': !isSidebarCollapsed}">
                æ”¶åˆå·¦å´æ¬„
            </span>
        </button>
    </aside>

    <!-- ä¸»è¦å…§å®¹å€ -->
    <main class="flex-grow flex flex-col h-full relative overflow-hidden bg-[#f8fafc]">
        <header class="h-16 bg-white border-b flex items-center justify-between px-8 flex-shrink-0 shadow-sm z-10">
            <h2 class="text-xl font-bold text-gray-800">{{ pageTitle }}</h2>
            <div class="flex items-center gap-4">
                <div v-if="isLoggedIn" class="flex items-center gap-2 px-4 py-1.5 bg-green-50 rounded-full border border-green-100 shadow-sm">
                    <div class="w-2.5 h-2.5 rounded-full bg-green-500 shadow-[0_0_8px_rgba(0,185,0,0.6)]"></div>
                    <span class="text-[10px] text-green-700 font-bold uppercase">LINE Connected</span>
                </div>
                <div v-else @click="liffLogin" class="flex items-center gap-2 px-4 py-1.5 bg-yellow-50 rounded-full border border-yellow-200 text-yellow-700 text-xs font-bold cursor-pointer hover:bg-yellow-100">
                    <i class="fas fa-sign-in-alt"></i> {{ isInIframe ? 'æ–°åˆ†é ç™»å…¥' : 'ç™»å…¥ LINE' }}
                </div>
                <div class="w-10 h-10 rounded-xl bg-line-green text-white flex items-center justify-center font-bold shadow-md">T</div>
            </div>
        </header>

        <div class="flex-grow overflow-hidden flex">
            <!-- ç·¨è¼¯èˆ‡é è¦½å€ -->
            <div v-if="currentTab === 'messages'" class="flex w-full overflow-hidden">
                <!-- å–®é æ–‡ç« å’Œå½±ç‰‡åç‰‡çš„ç·¨è¼¯å™¨ -->
                <div v-if="flexData.type !== 'ecommerce'" class="flex-grow overflow-y-auto p-8 bg-white shadow-inner border-r no-scrollbar">
                    <div class="max-w-4xl mx-auto">
                        <!-- å…±ç”¨é ‚éƒ¨æŒ‰éˆ•å€åŸŸ -->
                        <div class="flex items-center justify-between mb-8">
                            <div>
                                <h3 class="text-2xl font-bold text-gray-800">{{ flexData.type === 'video' ? 'å½±ç‰‡åç‰‡é–‹ç™¼' : 'æ–‡ç« å‹ Flex é–‹ç™¼' }}</h3>
                                <p class="text-sm text-gray-400 mt-1">ç·¨è¼¯åƒæ•¸å¾Œï¼Œå¯å„²å­˜ç‚ºå°ˆæ¡ˆæˆ–ç›´æ¥æ¨æ’­è‡³ LINEã€‚</p>
                            </div>
                            <div class="flex gap-2">
                                <button v-if="currentProjectId" @click="saveProject(true)" :disabled="isSaving" class="px-6 py-2.5 bg-purple-500 text-white rounded-xl text-sm font-bold shadow-lg hover:opacity-90 disabled:bg-gray-300 flex items-center gap-2">
                                    <i class="fas fa-save"></i> æ›´æ–°å°ˆæ¡ˆ
                                </button>
                                <button v-else @click="showNewProjectModal = true" :disabled="isSaving" class="px-6 py-2.5 bg-purple-500 text-white rounded-xl text-sm font-bold shadow-lg hover:opacity-90 disabled:bg-gray-300 flex items-center gap-2">
                                    <i class="fas fa-plus"></i> å„²å­˜ç‚ºæ–°å°ˆæ¡ˆ
                                </button>
                                <button @click="shareToLine" class="px-6 py-2.5 bg-blue-500 text-white rounded-xl text-sm font-bold shadow-lg hover:opacity-90 flex items-center gap-2">
                                    <i class="fas fa-paper-plane"></i> ğŸš€ ç›´æ¥æ¨æ’­
                                </button>
                                <button @click="saveToCloudflare" :disabled="isSaving" class="px-6 py-2.5 bg-line-green text-white rounded-xl text-sm font-bold shadow-lg hover:opacity-90 disabled:bg-gray-300">
                                    {{ isSaving ? 'åŒæ­¥ä¸­...' : 'å„²å­˜åˆ°é›²ç«¯' }}
                                </button>
                            </div>
                        </div>

                        <!-- å°ˆæ¡ˆé¡¯ç¤ºå€åŸŸ -->
                        <div v-if="currentProjectId" class="mb-6 p-4 bg-purple-50 rounded-xl border border-purple-100">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <i class="fas fa-box text-purple-500"></i>
                                    <div>
                                        <div class="font-bold text-gray-800">{{ currentProjectName }}</div>
                                        <div class="text-xs text-gray-500">å°ˆæ¡ˆID: {{ currentProjectId }}</div>
                                    </div>
                                </div>
                                <button @click="clearCurrentProject" class="text-sm text-gray-500 hover:text-red-500">
                                    <i class="fas fa-times"></i> æ¸…é™¤é¸æ“‡
                                </button>
                            </div>
                        </div>

                        <!-- ç·¨è¼¯å™¨å…§å®¹ -->
                        <div v-if="flexData.type === 'standard'" class="space-y-6">
                            <div class="bg-[#f8fafc] p-6 rounded-2xl border border-gray-100 shadow-sm">
                                <h4 class="text-sm font-bold text-gray-700 mb-4 flex items-center"><i class="fas fa-image mr-2 text-line-green"></i> è¦–è¦ºå…§å®¹è¨­å®š</h4>
                                <div class="space-y-4">
                                    <input type="text" v-model="flexData.imageUrl" class="w-full px-4 py-2 border rounded-xl text-sm focus:border-line-green shadow-sm" placeholder="åœ–ç‰‡ç¶²å€">
                                    <div class="flex items-center gap-3 mt-3">
                                        <button v-for="ratio in ['1:1', '20:13', '4:6']" @click="flexData.aspectRatio = ratio" :class="flexData.aspectRatio === ratio ? 'ratio-btn-active' : ''" class="ratio-btn shadow-sm">{{ ratio }}</button>
                                    </div>
                                    <input type="text" v-model="flexData.title" class="w-full px-4 py-2 border border-gray-200 rounded-xl text-sm focus:border-line-green shadow-sm" placeholder="è¼¸å…¥å¤§æ¨™é¡Œ">
                                    <textarea v-model="flexData.subtitle" rows="6" class="w-full px-4 py-3 border rounded-xl text-sm outline-none leading-relaxed focus:border-line-green shadow-sm" placeholder="è¼¸å…¥æ–‡ç« å…§å®¹..."></textarea>
                                </div>
                            </div>
                            <div class="bg-[#f8fafc] p-6 rounded-2xl border border-gray-100 mt-6 shadow-sm">
                                <h4 class="text-sm font-bold text-gray-700 mb-4 flex justify-between items-center">
                                    <span><i class="fas fa-mouse-pointer mr-2 text-line-green"></i> åº•éƒ¨è¡Œç‚ºæŒ‰éˆ•è¨­å®š</span>
                                </h4>
                                <div class="space-y-3">
                                    <div v-for="(btn, index) in flexData.buttons" :key="index" class="flex gap-3 items-center group bg-white p-3 rounded-xl border transition-all hover:border-green-100 shadow-sm">
                                        <input type="color" v-model="btn.color">
                                        <input type="text" v-model="btn.label" maxlength="10" class="w-32 px-4 py-2 border rounded-lg text-sm" placeholder="æ–‡å­—">
                                        <input type="text" v-model="btn.uri" class="flex-grow px-4 py-2 border rounded-lg text-sm" placeholder="ç¶²å€">
                                        <button @click="removeButton(index)" class="p-2 text-gray-300 hover:text-red-500 transition-colors"><i class="fas fa-trash-alt"></i></button>
                                    </div>
                                    <button v-if="flexData.buttons.length < 3" @click="addButton" class="w-full py-3 mt-2 border-2 border-dashed border-gray-200 rounded-2xl text-sm text-gray-400 bg-white font-bold hover:border-line-green transition-all">+ æ–°å¢åŠŸèƒ½æŒ‰éˆ•</button>
                                </div>
                            </div>
                        </div>

                        <div v-if="flexData.type === 'video'" class="space-y-6">
                            <div class="bg-[#f8fafc] p-6 rounded-2xl border border-gray-100 shadow-sm">
                                <h4 class="text-sm font-bold text-gray-700 mb-4 flex items-center"><i class="fas fa-id-card mr-2 text-line-green"></i> å½±ç‰‡èˆ‡åç‰‡ Header è¨­å®š</h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <input type="text" v-model="flexData.headerName" class="px-4 py-2 border rounded-lg text-sm focus:border-line-green outline-none shadow-sm" placeholder="å“ç‰Œå§“å">
                                    <input type="text" v-model="flexData.headerTitle" class="px-4 py-2 border rounded-lg text-sm focus:border-line-green outline-none shadow-sm" placeholder="è·ä½/ç¨±è™Ÿ">
                                    <input type="text" v-model="flexData.videoUrl" class="col-span-2 px-4 py-2 border rounded-lg text-sm focus:border-line-green outline-none shadow-sm" placeholder="å½±ç‰‡ MP4 é€£çµ">
                                    <div class="col-span-2">
                                        <input type="text" v-model="flexData.previewUrl" class="w-full px-4 py-2 border rounded-lg text-sm focus:border-line-green outline-none shadow-sm" placeholder="å½±ç‰‡é è¦½åœ– (Preview URL)">
                                    </div>
                                </div>
                            </div>
                            <div class="bg-[#f8fafc] p-6 rounded-2xl border border-gray-100 shadow-sm">
                                <h4 class="text-sm font-bold text-gray-700 mb-4 flex items-center"><i class="fas fa-th mr-2 text-line-green"></i> ç¶²æ ¼æŒ‰éˆ•è¨­å®š</h4>
                                <div class="space-y-3">
                                    <div v-for="(grid, index) in flexData.gridButtons" :key="index" class="grid grid-cols-2 gap-3">
                                        <div class="flex items-center gap-2">
                                            <input type="text" v-model="grid.emoji" class="w-16 px-3 py-2 border rounded-lg text-sm" placeholder="emoji">
                                            <input type="text" v-model="grid.label" class="flex-1 px-3 py-2 border rounded-lg text-sm" placeholder="æ¨™ç±¤æ–‡å­—">
                                        </div>
                                        <input type="text" v-model="grid.uri" class="px-3 py-2 border rounded-lg text-sm" placeholder="URL">
                                    </div>
                                </div>
                            </div>
                            <div class="bg-[#f8fafc] p-6 rounded-2xl border border-gray-100 shadow-sm">
                                <h4 class="text-sm font-bold text-gray-700 mb-4 flex items-center"><i class="fas fa-mouse-pointer mr-2 text-line-green"></i> å½±ç‰‡åº•éƒ¨ä¸»æŒ‰éˆ•è¨­å®š</h4>
                                <div class="space-y-3">
                                    <div v-for="(vBtn, vIdx) in flexData.videoFooterButtons" :key="vIdx" class="bg-white p-3 rounded-xl border flex gap-3 shadow-sm items-center transition-all hover:border-blue-100">
                                        <div v-if="vIdx === 0" class="flex flex-col items-center gap-1">
                                            <span class="text-[9px] text-gray-400 font-bold">ä¸»è‰²</span>
                                            <input type="color" v-model="vBtn.color">
                                        </div>
                                        <input type="text" v-model="vBtn.label" class="w-40 border rounded px-3 py-2 text-sm focus:border-blue-300 outline-none" placeholder="æ–‡å­—">
                                        <input type="text" v-model="vBtn.uri" class="flex-grow border rounded px-3 py-2 text-sm focus:border-blue-300 outline-none" placeholder="URL">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- JSON è¼¸å‡º -->
                        <div class="mt-12 mb-20">
                            <div class="flex items-center justify-between mb-3 px-2">
                                <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest"><i class="fas fa-code mr-2"></i>Raw Flex JSON Data</span>
                                <button @click="copyJson" class="text-[10px] text-line-green font-bold hover:underline uppercase">Copy JSON</button>
                            </div>
                            <div class="bg-[#1e2124] rounded-2xl p-6 border border-gray-700 shadow-xl overflow-hidden">
                                <pre class="text-[11px] text-green-400 font-mono leading-relaxed h-48 overflow-y-auto no-scrollbar">{{ generatedJson }}</pre>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- é›»å­å•†å‹™ç‰ˆç·¨è¼¯å™¨ -->
                <div v-if="flexData.type === 'ecommerce'" class="flex w-full overflow-hidden">
                    <!-- å·¦å´ç·¨è¼¯å™¨ -->
                    <div class="flex-grow overflow-y-auto p-8 bg-white shadow-inner border-r no-scrollbar">
                        <div class="max-w-4xl mx-auto">
                            <!-- å…±ç”¨é ‚éƒ¨æŒ‰éˆ•å€åŸŸ -->
                            <div class="flex items-center justify-between mb-8">
                                <div>
                                    <h3 class="text-2xl font-bold text-gray-800">é›»å•†å‹æ’ä»¶é–‹ç™¼</h3>
                                    <p class="text-sm text-gray-400 mt-1">ç·¨è¼¯åƒæ•¸å¾Œï¼Œå¯å„²å­˜ç‚ºå°ˆæ¡ˆæˆ–ç›´æ¥æ¨æ’­è‡³ LINEã€‚</p>
                                </div>
                                <div class="flex gap-2">
                                    <button v-if="currentProjectId" @click="saveProject(true)" :disabled="isSaving" class="px-6 py-2.5 bg-purple-500 text-white rounded-xl text-sm font-bold shadow-lg hover:opacity-90 disabled:bg-gray-300 flex items-center gap-2">
                                        <i class="fas fa-save"></i> æ›´æ–°å°ˆæ¡ˆ
                                    </button>
                                    <button v-else @click="showNewProjectModal = true" :disabled="isSaving" class="px-6 py-2.5 bg-purple-500 text-white rounded-xl text-sm font-bold shadow-lg hover:opacity-90 disabled:bg-gray-300 flex items-center gap-2">
                                        <i class="fas fa-plus"></i> å„²å­˜ç‚ºæ–°å°ˆæ¡ˆ
                                    </button>
                                    <button @click="shareToLine" class="px-6 py-2.5 bg-blue-500 text-white rounded-xl text-sm font-bold shadow-lg hover:opacity-90 flex items-center gap-2">
                                        <i class="fas fa-paper-plane"></i> ğŸš€ ç›´æ¥æ¨æ’­
                                    </button>
                                    <button @click="saveToCloudflare" :disabled="isSaving" class="px-6 py-2.5 bg-line-green text-white rounded-xl text-sm font-bold shadow-lg hover:opacity-90 disabled:bg-gray-300">
                                        {{ isSaving ? 'åŒæ­¥ä¸­...' : 'å„²å­˜åˆ°é›²ç«¯' }}
                                    </button>
                                </div>
                            </div>

                            <!-- å°ˆæ¡ˆé¡¯ç¤ºå€åŸŸ -->
                            <div v-if="currentProjectId" class="mb-6 p-4 bg-purple-50 rounded-xl border border-purple-100">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <i class="fas fa-box text-purple-500"></i>
                                        <div>
                                            <div class="font-bold text-gray-800">{{ currentProjectName }}</div>
                                            <div class="text-xs text-gray-500">å°ˆæ¡ˆID: {{ currentProjectId }}</div>
                                        </div>
                                    </div>
                                    <button @click="clearCurrentProject" class="text-sm text-gray-500 hover:text-red-500">
                                        <i class="fas fa-times"></i> æ¸…é™¤é¸æ“‡
                                    </button>
                                </div>
                            </div>

                            <!-- ç·¨è¼¯å™¨å…§å®¹ -->
                            <div class="space-y-6">
                                <!-- Hero è¨­å®š -->
                                <div class="bg-[#f8fafc] p-6 rounded-2xl border border-gray-100 shadow-sm">
                                    <h4 class="text-sm font-bold text-gray-700 mb-4 flex items-center"><i class="fas fa-image mr-2 text-line-green"></i> é ‚éƒ¨ Hero è¦–è¦º</h4>
                                    <div class="space-y-4">
                                        <div class="flex bg-slate-100 p-1 rounded-lg border border-slate-300">
                                            <button @click="updateHeroType('image')" :class="ecomState.hero.type === 'image' ? 'flex-1 py-1.5 text-xs font-bold rounded-md transition bg-white shadow-sm text-line-green border border-line-green' : 'flex-1 py-1.5 text-xs font-bold rounded-md transition text-slate-600 hover:bg-slate-200'">éœæ…‹åœ–ç‰‡</button>
                                            <button @click="updateHeroType('video')" :class="ecomState.hero.type === 'video' ? 'flex-1 py-1.5 text-xs font-bold rounded-md transition bg-white shadow-sm text-line-green border border-line-green' : 'flex-1 py-1.5 text-xs font-bold rounded-md transition text-slate-600 hover:bg-slate-200'">å½±ç‰‡æ’­æ”¾</button>
                                            <button @click="updateHeroType('none')" :class="ecomState.hero.type === 'none' ? 'flex-1 py-1.5 text-xs font-bold rounded-md transition bg-white shadow-sm text-line-green border border-line-green' : 'flex-1 py-1.5 text-xs font-bold rounded-md transition text-slate-600 hover:bg-slate-200'">ç„¡</button>
                                        </div>

                                        <div v-show="ecomState.hero.type !== 'none'" class="space-y-4">
                                            <div>
                                                <label class="text-[11px] font-bold text-slate-600 uppercase mb-1 block">é¡¯ç¤ºæ¯”ä¾‹</label>
                                                <select v-model="ecomState.hero.aspectRatio" @change="saveEcomHistory" class="w-full text-xs p-2.5 border border-slate-300 rounded-lg bg-white text-slate-800 focus:ring-2 focus:ring-line-green outline-none">
                                                    <option value="16:9">16:9 (å¯¬è¢å¹•)</option>
                                                    <option value="1:1">1:1 (æ­£æ–¹å½¢)</option>
                                                    <option value="4:3">4:3 (çŸ©å½¢)</option>
                                                    <option value="1.91:1">1.91:1 (æ©«å¹…)</option>
                                                    <option value="3:4">3:4 (ç›´å¼)</option>
                                                </select>
                                            </div>

                                            <div>
                                                <label class="block mb-1">
                                                    <span class="text-[11px] font-bold text-slate-700 uppercase block">{{ ecomState.hero.type === 'video' ? 'é è¦½å°é¢åœ– URL (Preview)' : 'åœ–ç‰‡ç¶²å€ (Image URL)' }}</span>
                                                    <span class="text-[10px] text-slate-400 font-normal">â€» è«‹è¼¸å…¥å…¬é–‹é€£çµ</span>
                                                </label>
                                                <input type="text" v-model="ecomState.hero.url" @input="saveEcomHistory" class="w-full text-xs p-2.5 bg-white border border-slate-300 rounded-lg text-slate-800 placeholder-slate-400 focus:border-line-green focus:ring-1 focus:ring-line-green outline-none">
                                            </div>
                                            
                                            <div v-if="ecomState.hero.type === 'video'">
                                                <label class="block mb-1">
                                                    <span class="text-[11px] font-bold text-slate-700 uppercase block">å½±ç‰‡ç¶²å€ (Video URL)</span>
                                                    <span class="text-[10px] text-slate-400 font-normal">â€» è«‹è¼¸å…¥ .mp4 çµå°¾çš„å½±ç‰‡é€£çµ</span>
                                                </label>
                                                <input type="text" v-model="ecomState.hero.videoUrl" @input="saveEcomHistory" class="w-full text-xs p-2.5 bg-white border border-slate-300 rounded-lg text-slate-800 placeholder-slate-400 focus:border-line-green focus:ring-1 focus:ring-line-green outline-none">
                                            </div>

                                            <div>
                                                <label class="block mb-1">
                                                    <span class="text-[11px] font-bold text-slate-700 uppercase block">é»æ“Šé€£çµ (Action URL)</span>
                                                    <span class="text-[10px] text-slate-400 font-normal">â€» é»æ“Šåœ–ç‰‡æˆ–å½±ç‰‡å¾Œè·³è½‰çš„ç¶²å€</span>
                                                </label>
                                                <input type="text" v-model="ecomState.hero.link" @input="saveEcomHistory" class="w-full text-xs p-2.5 bg-white border border-slate-300 rounded-lg text-slate-800 placeholder-slate-400 focus:border-line-green focus:ring-1 focus:ring-line-green outline-none">
                                            </div>
                                        </div>

                                        <div v-show="ecomState.hero.type === 'none'" class="text-center py-4 text-xs text-slate-400 bg-slate-50 rounded-lg border border-dashed border-slate-300">
                                            å·²éš±è— Hero å€å¡Š
                                        </div>
                                    </div>
                                </div>

                                <!-- Body è¨­å®š -->
                                <div class="bg-[#f8fafc] p-6 rounded-2xl border border-gray-100 shadow-sm">
                                    <h4 class="text-sm font-bold text-gray-700 mb-4 flex items-center justify-between">
                                        <span><i class="fas fa-palette mr-2 text-line-green"></i> Body å…§å®¹èˆ‡å°ºå¯¸</span>
                                        <span class="text-[10px] bg-white/20 px-2 py-0.5 rounded text-slate-700 font-mono">{{ ecomState.body.items.length }} items</span>
                                    </h4>
                                    <div class="space-y-4">
                                        <!-- å°ºå¯¸èˆ‡æ¬„ä½ -->
                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label class="text-[11px] font-bold text-slate-600 uppercase mb-1 block">å¡ç‰‡å°ºå¯¸ (Size)</label>
                                                <select v-model="ecomState.body.bubbleSize" @change="saveEcomHistory" class="w-full text-xs p-2.5 border border-slate-300 rounded-lg bg-white text-slate-800 focus:ring-1 focus:ring-line-green outline-none">
                                                    <option value="mega">MEGA (æ¨™æº–)</option>
                                                    <option value="giga">GIGA (å¯¬ç‰ˆ)</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="text-[11px] font-bold text-slate-600 uppercase mb-1 block">æ¯è¡Œæ¬„æ•¸</label>
                                                <select v-model="ecomState.body.columns" @change="saveEcomHistory" class="w-full text-xs p-2.5 border border-slate-300 rounded-lg bg-white text-slate-800 focus:ring-1 focus:ring-line-green outline-none">
                                                    <option value="3">3 æ¬„ä½</option>
                                                    <option value="4">4 æ¬„ä½</option>
                                                </select>
                                            </div>
                                        </div>

                                        <!-- æ¨™ç±¤é¡è‰²è¨­å®š -->
                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label class="text-[11px] font-bold text-slate-600 uppercase mb-1 block">æ¨™ç±¤èƒŒæ™¯è‰²</label>
                                                <div class="flex items-center gap-2 bg-white p-2 rounded-lg border border-slate-300 h-[42px]">
                                                    <input type="color" v-model="ecomState.body.tagBgColor" @change="saveEcomHistory" class="w-7 h-7 rounded cursor-pointer border-none p-0 flex-shrink-0">
                                                    <input type="text" v-model="ecomState.body.tagBgColor" @input="saveEcomHistory" class="flex-1 bg-transparent text-xs font-mono text-slate-700 outline-none uppercase">
                                                </div>
                                            </div>
                                            <div>
                                                <label class="text-[11px] font-bold text-slate-600 uppercase mb-1 block">æ¨™ç±¤æ–‡å­—è‰²</label>
                                                <div class="flex items-center gap-2 bg-white p-2 rounded-lg border border-slate-300 h-[42px]">
                                                    <input type="color" v-model="ecomState.body.tagTextColor" @change="saveEcomHistory" class="w-7 h-7 rounded cursor-pointer border-none p-0 flex-shrink-0">
                                                    <input type="text" v-model="ecomState.body.tagTextColor" @input="saveEcomHistory" class="flex-1 bg-transparent text-xs font-mono text-slate-700 outline-none uppercase">
                                                </div>
                                            </div>
                                        </div>

                                        <!-- èƒŒæ™¯é¡å‹åˆ‡æ› -->
                                        <div>
                                            <label class="text-[11px] font-bold text-slate-600 uppercase mb-1 block">èƒŒæ™¯é¡å‹</label>
                                            <div class="flex bg-slate-100 p-1 rounded-lg border border-slate-300">
                                                <button @click="updateBodyType('color')" :class="ecomState.body.bgType === 'color' ? 'flex-1 py-1.5 text-xs font-bold rounded-md transition bg-white shadow-sm text-line-green border border-line-green' : 'flex-1 py-1.5 text-xs font-bold rounded-md transition text-slate-600 hover:bg-slate-200'">ç´”è‰²èƒŒæ™¯</button>
                                                <button @click="updateBodyType('image')" :class="ecomState.body.bgType === 'image' ? 'flex-1 py-1.5 text-xs font-bold rounded-md transition bg-white shadow-sm text-line-green border border-line-green' : 'flex-1 py-1.5 text-xs font-bold rounded-md transition text-slate-600 hover:bg-slate-200'">åœ–ç‰‡èƒŒæ™¯</button>
                                            </div>
                                        </div>
                                        
                                        <!-- èƒŒæ™¯è©³ç´°è¨­å®š -->
                                        <div class="space-y-4">
                                            <div v-if="ecomState.body.bgType === 'color'">
                                                <label class="text-[11px] font-bold text-slate-600 uppercase mb-1 block">èƒŒæ™¯åº•è‰²</label>
                                                <div class="flex items-center gap-2 bg-white p-2 rounded-lg border border-slate-300 h-[42px]">
                                                    <input type="color" v-model="ecomState.body.bgColor" @change="saveEcomHistory" class="w-7 h-7 rounded cursor-pointer border-none p-0 flex-shrink-0">
                                                    <input type="text" v-model="ecomState.body.bgColor" @input="saveEcomHistory" class="flex-1 bg-transparent text-xs font-mono text-slate-700 outline-none uppercase">
                                                </div>
                                            </div>

                                            <div v-if="ecomState.body.bgType === 'image'" class="space-y-4">
                                                <div class="grid grid-cols-2 gap-3">
                                                    <div>
                                                        <label class="text-[11px] font-bold text-slate-600 uppercase mb-1 block">åœ–ç‰‡æ¨¡å¼</label>
                                                        <select v-model="ecomState.body.bgMode" @change="saveEcomHistory" class="w-full text-xs p-2.5 border border-slate-300 rounded-lg bg-white text-slate-800 focus:ring-1 focus:ring-line-green outline-none">
                                                            <option value="cover">å…¨ç‰ˆæ‹‰ä¼¸ (Cover)</option>
                                                            <option value="top">ç­‰æ¯”ç¸®æ”¾ (Fit Width)</option>
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <label class="text-[11px] font-bold text-slate-600 uppercase mb-1 block">èƒŒæ™¯åº•è‰² (è£œç™½ç”¨)</label>
                                                        <div class="flex items-center gap-2 bg-white p-2 rounded-lg border border-slate-300 h-[42px]">
                                                            <input type="color" v-model="ecomState.body.bgColor" @change="saveEcomHistory" class="w-7 h-7 rounded cursor-pointer border-none p-0 flex-shrink-0">
                                                            <input type="text" v-model="ecomState.body.bgColor" @input="saveEcomHistory" class="flex-1 bg-transparent text-xs font-mono text-slate-700 outline-none uppercase">
                                                        </div>
                                                    </div>
                                                </div>
                                                <div>
                                                    <label class="block mb-1">
                                                        <span class="text-[11px] font-bold text-slate-700 uppercase block">èƒŒæ™¯åœ–ç‰‡ç¶²å€</span>
                                                        <span class="text-[10px] text-slate-400 font-normal">â€» æ»¿ç‰ˆèƒŒæ™¯åœ– (Absolute Background)</span>
                                                    </label>
                                                    <input type="text" v-model="ecomState.body.bg" @input="saveEcomHistory" class="w-full text-xs p-2.5 bg-white border border-slate-300 rounded-lg text-slate-800 focus:border-line-green focus:ring-1 focus:ring-line-green outline-none">
                                                </div>
                                            </div>
                                        </div>

                                        <div class="space-y-3">
                                            <div v-for="(item, index) in ecomState.body.items" :key="index" class="p-3 bg-slate-50 border border-slate-300 rounded-xl space-y-2 relative group shadow-sm">
                                                <button @click="deleteEcomItem(index)" class="absolute top-2 right-2 text-slate-400 hover:text-red-600 transition">
                                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                </button>
                                                <div class="flex items-center gap-3">
                                                    <img :src="item.img" class="w-10 h-10 rounded-md object-cover border border-slate-300 bg-white">
                                                    <div class="flex-1 grid grid-cols-1 gap-2 mr-6">
                                                        <label class="text-[10px] text-slate-500 font-bold block mb-0.5">æ¨™ç±¤æ–‡å­—</label>
                                                        <input type="text" :value="item.title" @input="updateEcomItem(index, 'title', $event.target.value)" class="text-xs p-1.5 bg-white border border-slate-300 rounded font-bold text-slate-800 focus:border-line-green focus:ring-1 focus:ring-line-green outline-none" placeholder="æ¨™ç±¤æ–‡å­—">
                                                    </div>
                                                </div>
                                                <div class="flex gap-2">
                                                    <div class="flex-1">
                                                        <label class="text-[10px] text-slate-500 font-bold block mb-0.5">åœ–ç‰‡é€£çµ (Image URL)</label>
                                                        <input type="text" :value="item.img" @input="updateEcomItem(index, 'img', $event.target.value)" class="w-full text-[10px] p-1.5 bg-white border border-slate-300 rounded font-mono text-slate-600 focus:border-line-green focus:ring-1 focus:ring-line-green outline-none" placeholder="åœ–ç‰‡ URL">
                                                    </div>
                                                </div>
                                                <div>
                                                    <label class="text-[10px] text-slate-500 font-bold block mb-0.5">é»æ“Šé€£çµ (Action URL)</label>
                                                    <input type="text" :value="item.url" @input="updateEcomItem(index, 'url', $event.target.value)" class="w-full text-[10px] p-1.5 bg-white border border-slate-300 rounded font-mono text-slate-600 focus:border-line-green focus:ring-1 focus:ring-line-green outline-none" placeholder="https://...">
                                                </div>
                                            </div>
                                        </div>

                                        <button @click="addEcomItem" class="w-full py-2.5 border-2 border-dashed border-slate-400 rounded-xl text-slate-600 text-xs font-bold hover:border-line-green hover:text-line-green hover:bg-emerald-50 transition flex items-center justify-center gap-2">
                                            <i data-lucide="plus" class="w-4 h-4"></i> æ–°å¢å•†å“
                                        </button>
                                    </div>
                                </div>

                                <!-- Footer è¨­å®š -->
                                <div class="bg-[#f8fafc] p-6 rounded-2xl border border-gray-100 shadow-sm">
                                    <h4 class="text-sm font-bold text-gray-700 mb-4 flex items-center"><i class="fas fa-mouse-pointer mr-2 text-line-green"></i> åº•éƒ¨æŒ‰éˆ•</h4>
                                    <div class="space-y-4">
                                        
                                        <!-- Footer èƒŒæ™¯è‰² -->
                                        <div>
                                            <label class="text-[11px] font-bold text-slate-600 uppercase mb-1 block">åº•éƒ¨èƒŒæ™¯é¡è‰²</label>
                                            <div class="flex items-center gap-2 bg-white p-2 rounded-lg border border-slate-300 h-[42px]">
                                                <input type="color" v-model="ecomState.footer.bg" @change="saveEcomHistory" class="w-7 h-7 rounded cursor-pointer border-none p-0 flex-shrink-0">
                                                <input type="text" v-model="ecomState.footer.bg" @input="saveEcomHistory" class="flex-1 bg-transparent text-xs font-mono text-slate-700 outline-none uppercase">
                                            </div>
                                        </div>

                                        <!-- Footer èªªæ˜æ–‡å­—é–‹é—œ -->
                                        <div class="flex items-center justify-between">
                                            <label class="text-[11px] font-bold text-slate-600 uppercase">å•Ÿç”¨èªªæ˜æ–‡å­—</label>
                                            <label class="relative inline-flex items-center cursor-pointer">
                                                <input type="checkbox" v-model="ecomState.footer.textEnabled" @change="saveEcomHistory" class="sr-only peer">
                                                <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-line-green"></div>
                                            </label>
                                        </div>

                                        <div v-show="ecomState.footer.textEnabled" class="space-y-3">
                                            <div class="flex justify-between items-center">
                                                <label class="block text-[11px] font-bold text-slate-600 uppercase">èªªæ˜å…§å®¹</label>
                                                <div class="flex gap-2">
                                                    <!-- Text Color Picker -->
                                                    <div class="flex items-center gap-1 border border-slate-300 rounded bg-white px-1 py-0.5" title="æ–‡å­—é¡è‰²">
                                                        <input type="color" v-model="ecomState.footer.textColor" @change="saveEcomHistory" class="w-4 h-4 rounded cursor-pointer border-none p-0">
                                                        <input type="text" v-model="ecomState.footer.textColor" @input="saveEcomHistory" class="w-12 text-[10px] font-mono text-slate-600 outline-none uppercase">
                                                    </div>
                                                    <!-- Alignment -->
                                                    <div class="flex bg-slate-200 rounded p-0.5 space-x-0.5">
                                                        <button @click="updateFooterTextAlign('start')" :class="ecomState.footer.textAlign === 'start' ? 'p-1 rounded bg-white shadow-sm text-line-green border border-slate-200 transition' : 'p-1 rounded hover:bg-white transition text-slate-600'" title="é å·¦"><i data-lucide="align-left" class="w-3 h-3"></i></button>
                                                        <button @click="updateFooterTextAlign('center')" :class="ecomState.footer.textAlign === 'center' ? 'p-1 rounded bg-white shadow-sm text-line-green border border-slate-200 transition' : 'p-1 rounded hover:bg-white transition text-slate-600'" title="ç½®ä¸­"><i data-lucide="align-center" class="w-3 h-3"></i></button>
                                                        <button @click="updateFooterTextAlign('end')" :class="ecomState.footer.textAlign === 'end' ? 'p-1 rounded bg-white shadow-sm text-line-green border border-slate-200 transition' : 'p-1 rounded hover:bg-white transition text-slate-600'" title="é å³"><i data-lucide="align-right" class="w-3 h-3"></i></button>
                                                    </div>
                                                </div>
                                            </div>
                                            <textarea v-model="ecomState.footer.text" @input="saveEcomHistory" rows="3" class="w-full text-xs p-2.5 bg-white border border-slate-300 rounded-lg text-slate-800 focus:border-line-green focus:ring-1 focus:ring-line-green outline-none" placeholder="è«‹è¼¸å…¥èªªæ˜æ–‡å­—..."></textarea>
                                        </div>

                                        <div class="p-3 bg-slate-50 border border-slate-300 rounded-xl">
                                            <div class="text-[11px] font-bold text-slate-700 mb-2">æŒ‰éˆ• 1 (Primary)</div>
                                            <div class="flex gap-2 mb-2">
                                                <input type="text" v-model="ecomState.footer.btn1.label" @input="saveEcomHistory" class="flex-1 text-xs p-2 border border-slate-300 rounded bg-white focus:border-line-green focus:ring-1 focus:ring-line-green outline-none" placeholder="åç¨±">
                                                <div class="flex items-center gap-1 border border-slate-300 rounded bg-white px-2 py-1 w-28">
                                                    <input type="color" v-model="ecomState.footer.btn1.color" @change="saveEcomHistory" class="w-5 h-5 rounded cursor-pointer border-none shadow-sm">
                                                    <input type="text" v-model="ecomState.footer.btn1.color" @input="saveEcomHistory" class="flex-1 text-[10px] font-mono text-slate-600 outline-none uppercase text-center">
                                                </div>
                                            </div>
                                            <input type="text" v-model="ecomState.footer.btn1.uri" @input="saveEcomHistory" class="w-full text-xs p-2 border border-slate-300 rounded font-mono bg-white text-slate-600 focus:border-line-green focus:ring-1 focus:ring-line-green outline-none" placeholder="https://...">
                                        </div>
                                        <div class="p-3 bg-slate-50 border border-slate-300 rounded-xl">
                                            <div class="text-[11px] font-bold text-slate-700 mb-2">æŒ‰éˆ• 2 (Primary)</div>
                                            <div class="flex gap-2 mb-2">
                                                <input type="text" v-model="ecomState.footer.btn2.label" @input="saveEcomHistory" class="flex-1 text-xs p-2 border border-slate-300 rounded bg-white focus:border-line-green focus:ring-1 focus:ring-line-green outline-none" placeholder="åç¨±">
                                                <div class="flex items-center gap-1 border border-slate-300 rounded bg-white px-2 py-1 w-28">
                                                    <input type="color" v-model="ecomState.footer.btn2.color" @change="saveEcomHistory" class="w-5 h-5 rounded cursor-pointer border-none shadow-sm">
                                                    <input type="text" v-model="ecomState.footer.btn2.color" @input="saveEcomHistory" class="flex-1 text-[10px] font-mono text-slate-600 outline-none uppercase text-center">
                                                </div>
                                            </div>
                                            <input type="text" v-model="ecomState.footer.btn2.uri" @input="saveEcomHistory" class="w-full text-xs p-2 border border-slate-300 rounded font-mono bg-white text-slate-600 focus:border-line-green focus:ring-1 focus:ring-line-green outline-none" placeholder="https://...">
                                        </div>
                                    </div>
                                </div>

                                <!-- JSON è¼¸å‡º -->
                                <div class="mt-12 mb-20">
                                    <div class="flex items-center justify-between mb-3 px-2">
                                        <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest"><i class="fas fa-code mr-2"></i>Raw Flex JSON Data</span>
                                        <button @click="copyEcommerceJson" class="text-[10px] text-line-green font-bold hover:underline uppercase">Copy JSON</button>
                                    </div>
                                    <div class="bg-[#1e2124] rounded-2xl p-6 border border-gray-700 shadow-xl overflow-hidden">
                                        <pre class="text-[11px] text-green-400 font-mono leading-relaxed h-48 overflow-y-auto no-scrollbar">{{ generateEcommerceJson() }}</pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å³å´é è¦½å€ -->
                    <div class="w-[360px] flex-shrink-0 bg-slate-100 relative overflow-hidden flex flex-col">
                        <div class="chat-room-bg custom-scrollbar">
                            <!-- æ¨¡æ“¬æ—¥æœŸæ¨™ç±¤ -->
                            <div class="text-center my-4">
                                <span class="bg-black/20 text-white text-[10px] px-2 py-1 rounded-full backdrop-blur-sm">Today</span>
                            </div>

                            <!-- Flex æ°£æ³¡æœ¬é«” -->
                            <div class="flex items-start gap-2 mb-8 w-full justify-center">
                                <!-- é ­åƒ -->
                                <div class="w-8 h-8 rounded-full bg-slate-400 shrink-0 self-start mt-1"></div>
                                
                                <!-- æ°£æ³¡å…§å®¹ -->
                                <div class="bg-white rounded-xl overflow-hidden flex-bubble-container flex flex-col">
                                    
                                    <!-- Hero Area -->
                                    <div v-show="ecomState.hero.type !== 'none'" :class="getAspectClass(ecomState.hero.aspectRatio)" class="relative w-full bg-black overflow-hidden group cursor-pointer shrink-0">
                                        <img v-show="ecomState.hero.type === 'image'" :src="ecomState.hero.url" class="w-full h-full object-cover">
                                        <div v-show="ecomState.hero.type === 'video'" class="absolute inset-0 flex items-center justify-center">
                                            <img :src="ecomState.hero.url" class="absolute inset-0 w-full h-full object-cover opacity-70">
                                            <div class="relative z-10 w-12 h-12 bg-white/90 rounded-full flex items-center justify-center shadow-lg">
                                                <i data-lucide="play" class="w-5 h-5 text-slate-900 fill-slate-900 ml-1"></i>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Body Area -->
                                    <div class="relative w-full" :style="{ backgroundColor: ecomState.body.bgColor }">
                                        <!-- èƒŒæ™¯åœ– -->
                                        <img v-if="ecomState.body.bgType === 'image' && ecomState.body.bg" :src="ecomState.body.bg" 
                                             :class="ecomState.body.bgMode === 'top' ? 'object-contain' : 'object-cover'"
                                             class="absolute inset-0 w-full h-full z-0">
                                        
                                        <!-- å…§å®¹ç¶²æ ¼ -->
                                        <div class="relative z-10 p-4">
                                            <div :class="ecomState.body.columns === 3 ? 'grid-cols-3' : 'grid-cols-4'" class="grid gap-2">
                                                <div v-for="(item, index) in ecomState.body.items" :key="index" class="bg-white rounded-md p-1 shadow-sm flex flex-col">
                                                    <div class="relative w-full aspect-square bg-slate-100 rounded-sm overflow-hidden mb-1">
                                                        <img :src="item.img" class="w-full h-full object-cover">
                                                    </div>
                                                    <div :style="{ backgroundColor: ecomState.body.tagBgColor, color: ecomState.body.tagTextColor }" class="text-[8px] font-bold text-center py-1 px-1 rounded-sm truncate">
                                                        {{ item.title }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Footer Area -->
                                    <div class="p-3 border-t border-slate-100 flex flex-col gap-2 shrink-0 relative z-10" :style="{ backgroundColor: ecomState.footer.bg }">
                                        <div v-show="ecomState.footer.textEnabled" :style="{ color: ecomState.footer.textColor }" 
                                             :class="getTextAlignClass(ecomState.footer.textAlign)"
                                             class="text-xs whitespace-pre-wrap mb-2 w-full">
                                            {{ ecomState.footer.text }}
                                        </div>
                                        <div class="flex gap-2 w-full">
                                            <button :style="{ backgroundColor: ecomState.footer.btn1.color }" 
                                                    class="flex-1 py-2 rounded text-[10px] font-bold text-white text-center transition hover:opacity-90">
                                                {{ ecomState.footer.btn1.label }}
                                            </button>
                                            <button :style="{ backgroundColor: ecomState.footer.btn2.color }" 
                                                    class="flex-1 py-2 rounded text-[10px] font-bold text-white text-center transition hover:opacity-90">
                                                {{ ecomState.footer.btn2.label }}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- åº•éƒ¨ç•™ç™½ -->
                            <div class="h-10 w-full shrink-0"></div>
                        </div>
                    </div>
                </div>

                <!-- æ‰‹æ©Ÿé è¦½å€ï¼ˆå–®é æ–‡ç« å’Œå½±ç‰‡åç‰‡ï¼‰ -->
                <div v-if="flexData.type !== 'ecommerce'" class="w-[360px] flex-shrink-0 bg-gray-50 flex items-center justify-center py-8 shadow-inner overflow-y-auto no-scrollbar">
                    <div class="flex flex-col items-center gap-4">
                        <div class="preview-window no-scrollbar shadow-2xl">
                            <div class="p-3 border-b border-gray-800 bg-[#1A1B1E] flex items-center gap-2 sticky top-0 z-50">
                                <i class="fas fa-chevron-left text-gray-600 text-xs"></i>
                                <span class="text-[9px] font-bold text-gray-500 uppercase tracking-tighter">LINE Preview</span>
                            </div>

                            <div v-if="flexData.type === 'standard'" class="p-4">
                                <div class="flex-bubble shadow-xl relative overflow-hidden">
                                    <div class="relative">
                                        <img :src="flexData.imageUrl" :style="{ aspectRatio: flexData.aspectRatio.replace(':', '/') }" class="w-full object-cover transition-all" onerror="this.src='https://via.placeholder.com/250x160?text=Image'">
                                        <div class="flex-badge shadow-md" v-if="flexData.showBadge" :style="{ backgroundColor: flexData.badgeColor }">åˆ†äº«</div>
                                    </div>
                                    <div class="p-4 text-center">
                                        <div class="text-base font-bold truncate">{{ flexData.title || 'æ¨™é¡Œ' }}</div>
                                        <div class="text-[10px] text-gray-500 preview-article mt-2">{{ flexData.subtitle || 'å…§å®¹å€...' }}</div>
                                    </div>
                                    <div class="p-3 pt-0 space-y-1.5">
                                        <button v-for="btn in flexData.buttons" class="w-full py-1.5 text-white text-[10px] font-bold rounded shadow-sm" :style="{ backgroundColor: btn.color }">{{ btn.label }}</button>
                                    </div>
                                </div>
                            </div>

                            <div v-if="flexData.type === 'video'" class="p-4">
                                <div class="flex-bubble flex-bubble-dark shadow-2xl border-gray-800 overflow-hidden">
                                    <div class="header-box">
                                        <img :src="flexData.headerImg" class="w-10 h-10 rounded-full object-cover border border-gray-700">
                                        <span class="text-[11px] font-bold truncate uppercase" style="color:#D4AF37">{{flexData.headerName || 'å§“å'}}</span>
                                    </div>
                                    <div class="video-hero">
                                        <img :src="flexData.previewUrl" class="w-full h-full object-cover opacity-60">
                                        <div class="absolute inset-0 flex items-center justify-center"><i class="fas fa-play-circle text-white text-4xl opacity-90 drop-shadow-lg"></i></div>
                                    </div>
                                    <div class="grid-box">
                                        <div v-for="(grid, gIdx) in flexData.gridButtons" :key="gIdx" class="grid-item">
                                            <div class="text-xl mb-1">{{grid.emoji}}</div>
                                            <div class="text-[8px] text-gray-300 font-bold truncate uppercase tracking-tighter">{{grid.label || 'Grid'}}</div>
                                        </div>
                                    </div>
                                    <div class="p-3 pt-0 space-y-2 bg-[#0F0F10]">
                                        <button v-for="(vBtn, vI) in flexData.videoFooterButtons" :key="vI" 
                                                class="w-full py-2 text-[10px] font-bold rounded shadow-md transition-all active:scale-95"
                                                :style="vI === 0 ? { backgroundColor: vBtn.color, color: '#fff' } : { backgroundColor: '#2A2C31', color: '#999' }">
                                            {{vBtn.label || 'æŒ‰éˆ•'}}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æ’ä»¶æ¨¡æ¿åº« -->
            <div v-if="currentTab === 'templates'" class="w-full overflow-y-auto p-8">
                <div class="max-w-7xl mx-auto">
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">æ’ä»¶æ¨¡æ¿åº«</h3>
                    <p class="text-gray-500 mb-8">é¸æ“‡æ¨¡æ¿å¿«é€Ÿé–‹å§‹ä½ çš„æ’ä»¶è¨­è¨ˆ</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div v-for="(template, idx) in templates" :key="idx" 
                             @click="applyTemplate(template)"
                             class="bg-white rounded-2xl overflow-hidden shadow-lg hover:shadow-2xl transition-all duration-300 hover:-translate-y-1 cursor-pointer group">
                            <div class="template-aspect overflow-hidden bg-gray-100">
                                <img :src="template.thumbnail" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105">
                            </div>
                            <div class="p-5">
                                <div class="flex items-center justify-between mb-2">
                                    <h4 class="font-bold text-gray-800">{{ template.name }}</h4>
                                    <span class="px-2 py-1 text-xs rounded-full" 
                                          :class="template.type === 'video' ? 'bg-purple-100 text-purple-700' : 
                                                 template.type === 'ecommerce' ? 'bg-orange-100 text-orange-700' : 'bg-green-100 text-green-700'">
                                        {{ template.type === 'video' ? 'å½±ç‰‡å‹' : 
                                           template.type === 'ecommerce' ? 'é›»å•†å‹' : 'æ–‡ç« å‹' }}
                                    </span>
                                </div>
                                <p class="text-sm text-gray-500 mb-4">é»æ“Šç«‹å³å¥—ç”¨æ¨¡æ¿</p>
                                <button class="w-full py-2.5 bg-line-green text-white rounded-xl text-sm font-bold hover:opacity-90 transition-all">
                                    ç«‹å³å¥—ç”¨
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å°ˆæ¡ˆç®¡ç†é é¢ -->
            <div v-if="currentTab === 'projects'" class="w-full overflow-y-auto p-8">
                <div class="max-w-7xl mx-auto">
                    <div class="flex items-center justify-between mb-8">
                        <div>
                            <h3 class="text-2xl font-bold text-gray-800 mb-2">å°ˆæ¡ˆç®¡ç†</h3>
                            <p class="text-gray-500">ç®¡ç†æ‚¨çš„æ’ä»¶è¨­è¨ˆå°ˆæ¡ˆï¼Œå¯ä»¥å„²å­˜ã€ç·¨è¼¯å’Œåˆªé™¤</p>
                        </div>
                        <button @click="showNewProjectModal = true" 
                                class="px-6 py-3 bg-line-green text-white rounded-xl text-sm font-bold shadow-lg hover:opacity-90 flex items-center gap-2">
                            <i class="fas fa-plus"></i> æ–°å¢å°ˆæ¡ˆ
                        </button>
                    </div>
                    
                    <!-- å°ˆæ¡ˆç¯©é¸å™¨ -->
                    <div class="mb-6 p-4 bg-white rounded-xl border shadow-sm">
                        <div class="flex items-center gap-4">
                            <div class="flex-1">
                                <input type="text" v-model="projectSearch" 
                                       placeholder="æœå°‹å°ˆæ¡ˆåç¨±æˆ–é¡å‹..." 
                                       class="w-full px-4 py-2 border rounded-lg focus:border-line-green outline-none">
                            </div>
                            <div class="flex gap-2">
                                <button @click="loadProjects" class="px-4 py-2 bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100">
                                    <i class="fas fa-sync-alt"></i> é‡æ–°æ•´ç†
                                </button>
                                <button @click="initializeSheets" class="px-4 py-2 bg-green-50 text-green-700 rounded-lg hover:bg-green-100">
                                    <i class="fas fa-database"></i> åˆå§‹åŒ–
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- è¼‰å…¥ä¸­ç‹€æ…‹ -->
                    <div v-if="loadingProjects" class="text-center py-12">
                        <div class="spinner mx-auto mb-4"></div>
                        <p class="text-gray-500">è¼‰å…¥å°ˆæ¡ˆä¸­...</p>
                    </div>
                    
                    <!-- å°ˆæ¡ˆåˆ—è¡¨ -->
                    <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div v-for="project in filteredProjects" :key="project.id" 
                             class="project-card">
                            <div class="p-5">
                                <div class="flex items-start justify-between mb-3">
                                    <div>
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="px-2 py-1 text-xs rounded-full" 
                                                  :class="project.type === 'video' ? 'bg-purple-100 text-purple-700' : 
                                                         project.type === 'ecommerce' ? 'bg-orange-100 text-orange-700' : 'bg-green-100 text-green-700'">
                                                {{ project.type === 'video' ? 'å½±ç‰‡å‹' : 
                                                   project.type === 'ecommerce' ? 'é›»å•†å‹' : 'æ–‡ç« å‹' }}
                                            </span>
                                            <span class="text-xs text-gray-500">{{ formatDate(project.created_at) }}</span>
                                        </div>
                                        <h4 class="font-bold text-lg text-gray-800">{{ project.name }}</h4>
                                        <p class="text-sm text-gray-500 mt-1">{{ project.description || 'æœªæ·»åŠ æè¿°' }}</p>
                                    </div>
                                    <button @click="deleteProject(project.id)" 
                                            class="text-gray-400 hover:text-red-500 transition-colors">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                                
                                <div class="mt-4 flex gap-2">
                                    <button @click="loadProject(project)" 
                                            class="flex-1 py-2 bg-line-green text-white rounded-lg text-sm font-bold hover:opacity-90">
                                        <i class="fas fa-edit"></i> ç·¨è¼¯
                                    </button>
                                    <button @click="pushProject(project)" 
                                            class="flex-1 py-2 bg-blue-500 text-white rounded-lg text-sm font-bold hover:opacity-90">
                                        <i class="fas fa-paper-plane"></i> æ¨æ’­
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ç„¡å°ˆæ¡ˆæ™‚çš„æç¤º -->
                    <div v-if="!loadingProjects && projects.length === 0" class="text-center py-16">
                        <i class="fas fa-box-open text-5xl text-gray-300 mb-4"></i>
                        <h4 class="text-xl font-bold text-gray-500 mb-2">å°šç„¡å°ˆæ¡ˆ</h4>
                        <p class="text-gray-400 mb-6">é–‹å§‹å‰µå»ºæ‚¨çš„ç¬¬ä¸€å€‹æ’ä»¶å°ˆæ¡ˆå§ï¼</p>
                        <button @click="showNewProjectModal = true" 
                                class="px-6 py-3 bg-line-green text-white rounded-xl text-sm font-bold shadow-lg hover:opacity-90">
                            å‰µå»ºç¬¬ä¸€å€‹å°ˆæ¡ˆ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- æ–°å¢å°ˆæ¡ˆæ¨¡æ…‹è¦–çª— -->
    <div v-if="showNewProjectModal" class="modal-overlay" @click.self="showNewProjectModal = false">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-800">å„²å­˜ç‚ºæ–°å°ˆæ¡ˆ</h3>
                <button @click="showNewProjectModal = false" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">å°ˆæ¡ˆåç¨± *</label>
                    <input type="text" v-model="newProject.name" 
                           class="w-full px-4 py-2 border rounded-lg focus:border-line-green outline-none"
                           placeholder="ä¾‹å¦‚ï¼šç”¢å“ä»‹ç´¹å¡ç‰‡">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">å°ˆæ¡ˆæè¿°</label>
                    <textarea v-model="newProject.description" rows="3"
                              class="w-full px-4 py-2 border rounded-lg focus:border-line-green outline-none"
                              placeholder="æè¿°æ­¤å°ˆæ¡ˆçš„ç”¨é€”å’Œå…§å®¹"></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">å°ˆæ¡ˆé¡å‹</label>
                    <div class="flex gap-2">
                        <button @click="newProject.type = 'standard'" 
                                :class="newProject.type === 'standard' ? 'bg-green-100 text-green-700 border-green-300' : 'bg-gray-100 text-gray-700'"
                                class="flex-1 py-2 border rounded-lg text-sm font-medium">
                            æ–‡ç« å‹
                        </button>
                        <button @click="newProject.type = 'video'" 
                                :class="newProject.type === 'video' ? 'bg-purple-100 text-purple-700 border-purple-300' : 'bg-gray-100 text-gray-700'"
                                class="flex-1 py-2 border rounded-lg text-sm font-medium">
                            å½±ç‰‡å‹
                        </button>
                        <button @click="newProject.type = 'ecommerce'" 
                                :class="newProject.type === 'ecommerce' ? 'bg-orange-100 text-orange-700 border-orange-300' : 'bg-gray-100 text-gray-700'"
                                class="flex-1 py-2 border rounded-lg text-sm font-medium">
                            é›»å•†å‹
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="mt-8 flex gap-3">
                <button @click="showNewProjectModal = false" 
                        class="flex-1 py-3 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50">
                    å–æ¶ˆ
                </button>
                <button @click="saveProject(false)" 
                        :disabled="!newProject.name || isSaving"
                        class="flex-1 py-3 bg-line-green text-white rounded-lg font-bold hover:opacity-90 disabled:bg-gray-300">
                    {{ isSaving ? 'å„²å­˜ä¸­...' : 'å„²å­˜å°ˆæ¡ˆ' }}
                </button>
            </div>
        </div>
    </div>
    
    <!-- åˆªé™¤ç¢ºèªæ¨¡æ…‹è¦–çª— -->
    <div v-if="showDeleteConfirm" class="modal-overlay" @click.self="showDeleteConfirm = false">
        <div class="modal-content">
            <div class="text-center">
                <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                <h3 class="text-xl font-bold text-gray-800 mb-2">ç¢ºèªåˆªé™¤</h3>
                <p class="text-gray-600 mb-6">æ‚¨ç¢ºå®šè¦åˆªé™¤æ­¤å°ˆæ¡ˆå—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚</p>
                
                <div class="flex gap-3">
                    <button @click="showDeleteConfirm = false" 
                            class="flex-1 py-3 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50">
                        å–æ¶ˆ
                    </button>
                    <button @click="confirmDelete" 
                            class="flex-1 py-3 bg-red-500 text-white rounded-lg font-bold hover:opacity-90">
                        ç¢ºèªåˆªé™¤
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const { createApp, ref, computed, onMounted, nextTick } = Vue;

// Cloudflare Worker URL
const WORKER_URL = "https://lineoa.fangwl591021.workers.dev";

createApp({
  setup() {
    // ç‹€æ…‹è®Šæ•¸
    const isSidebarCollapsed = ref(false);
    const isMessageMenuOpen = ref(true);
    const currentTab = ref('messages');
    const currentSubTab = ref('single');
    const isSaving = ref(false);
    const isLoggedIn = ref(false);
    const isInIframe = ref(false);
    const liffProfile = ref(null);
    
    // å°ˆæ¡ˆç›¸é—œç‹€æ…‹
    const showNewProjectModal = ref(false);
    const showDeleteConfirm = ref(false);
    const projectSearch = ref('');
    const projects = ref([]);
    const loadingProjects = ref(false);
    const currentProjectId = ref(null);
    const currentProjectName = ref('');
    const projectToDelete = ref(null);
    
    // æ–°å°ˆæ¡ˆè³‡æ–™
    const newProject = ref({
      name: '',
      description: '',
      type: 'standard'
    });

    onMounted(async () => {
      isInIframe.value = window.self !== window.top;
      if (typeof liff !== 'undefined') {
        try {
          await liff.init({ liffId: "2008541971-XPIDtaaj" });
          console.log("LIFF Ready");
          isLoggedIn.value = liff.isLoggedIn();
          
          if (isLoggedIn.value) {
            liffProfile.value = await liff.getProfile();
            console.log("User Profile:", liffProfile.value);
          }
        } catch (err) {
          console.error("LIFF Init failed", err);
        }
      }
      
      // åˆå§‹åŒ–åœ–æ¨™
      if (window.lucide) {
        window.lucide.createIcons();
      }
      
      // æª¢æŸ¥ä¸¦åˆå§‹åŒ– Google Sheets
      await checkSheetsStatus();
    });

    // é›»å­å•†å‹™ç‰ˆæ•¸æ“š
    const ecomState = ref({
      hero: {
        type: 'video', 
        aspectRatio: '16:9',
        url: "https://lihi.cc/5OXMZ", 
        videoUrl: "https://lihi.cc/YsmAp", 
        link: "https://line.me"
      },
      body: {
        columns: 3,
        bubbleSize: "mega", 
        bgType: "image", // color | image
        bgMode: "cover", // cover | top
        bgColor: "#F8F8F8", // Body é è¨­åº•è‰²
        bg: "https://lihi.cc/l5qqU",
        tagBgColor: "#0D0D0D",
        tagTextColor: "#FFFFFF",
        items: [
          { title: "å•†å“ A", img: "https://lihi.cc/mwMvo", url: "https://line.me" },
          { title: "å•†å“ B", img: "https://lihi.cc/2Nu8G", url: "https://line.me" },
          { title: "å•†å“ C", img: "https://lihi.cc/yRfpn", url: "https://line.me" },
          { title: "å•†å“ D", img: "https://lihi.cc/yRfpn", url: "https://line.me" },
          { title: "å•†å“ E", img: "https://lihi.cc/2Nu8G", url: "https://line.me" },
          { title: "å•†å“ F", img: "https://lihi.cc/mwMvo", url: "https://line.me" }
        ]
      },
      footer: {
        bg: "#ffffff", 
        textEnabled: false,
        text: "â€» è«‹æ³¨æ„ï¼šå„ªæƒ å•†å“æ•¸é‡æœ‰é™ï¼Œå”®å®Œç‚ºæ­¢ã€‚",
        textColor: "#666666",
        textAlign: "center", // start, center, end
        btn1: { label: "å“ç‰Œæ•…äº‹", color: "#000000", uri: "https://liff.line.me/2008704329-cTkwlRHm" },
        btn2: { label: "å¥½å‹åˆ†äº«", color: "#000000", uri: "line://nv/recommendOA/@754tjssx" }
      }
    });

    const ecomHistory = ref([]);

    // é›»å­å•†å‹™ç‰ˆæ–¹æ³•
    const saveEcomHistory = () => {
      if (ecomHistory.value.length > 20) ecomHistory.value.shift();
      ecomHistory.value.push(JSON.parse(JSON.stringify(ecomState.value)));
    };

    const updateHeroType = (type) => {
      saveEcomHistory();
      ecomState.value.hero.type = type;
    };

    const updateBodyType = (type) => {
      saveEcomHistory();
      ecomState.value.body.bgType = type;
    };

    const updateFooterTextAlign = (align) => {
      saveEcomHistory();
      ecomState.value.footer.textAlign = align;
    };

    const updateEcomItem = (index, field, value) => {
      saveEcomHistory();
      ecomState.value.body.items[index][field] = value;
    };

    const addEcomItem = () => {
      saveEcomHistory();
      ecomState.value.body.items.push({ 
        title: "æ–°å•†å“", 
        img: "https://lihi.cc/mwMvo", 
        url: "https://line.me" 
      });
    };

    const deleteEcomItem = (index) => {
      saveEcomHistory();
      ecomState.value.body.items.splice(index, 1);
    };

    const getAspectClass = (aspect) => {
      const ratioMap = { 
        '1:1': 'aspect-1-1', 
        '16:9': 'aspect-16-9', 
        '4:3': 'aspect-4-3', 
        '1.91:1': 'aspect-1_91-1', 
        '3:4': 'aspect-3-4' 
      };
      return ratioMap[aspect] || 'aspect-16-9';
    };

    const getTextAlignClass = (align) => {
      const alignMap = { 
        'start': 'text-left', 
        'center': 'text-center', 
        'end': 'text-right' 
      };
      return alignMap[align] || 'text-center';
    };

    // ç”Ÿæˆé›»å­å•†å‹™ç‰ˆ JSON
    const generateEcommerceJson = () => {
      const cols = ecomState.value.body.columns;
      const width = cols === 3 ? "32%" : "23%";
      const chunk = (arr, size) => Array.from({ length: Math.ceil(arr.length / size) }, (v, i) => arr.slice(i * size, i * size + size));
      
      // åŸºç¤ Body è¨­å®š
      const bodyConfig = {
        "type": "box",
        "layout": "vertical",
        "backgroundColor": ecomState.value.body.bgColor,
        "paddingAll": "none",
        "contents": []
      };

      // æ§‹å»ºå…§éƒ¨çµæ§‹
      const productContent = {
        "type": "box",
        "layout": "vertical",
        "contents": chunk(ecomState.value.body.items, cols).map((row, idx) => ({
          "type": "box",
          "layout": "horizontal",
          "margin": idx === 0 ? "none" : "md",
          "contents": row.map((item, colIdx) => ({
            "type": "box",
            "layout": "vertical",
            "contents": [
              {
                "type": "image",
                "url": item.img,
                "aspectRatio": "1:1",
                "size": "full",
                "aspectMode": "cover"
              },
              {
                "type": "box",
                "layout": "vertical",
                "contents": [
                  {
                    "type": "text",
                    "text": item.title,
                    "size": "xxs",
                    "color": ecomState.value.body.tagTextColor,
                    "align": "center",
                    "weight": "bold",
                    "wrap": true
                  }
                ],
                "backgroundColor": ecomState.value.body.tagBgColor,
                "cornerRadius": "sm",
                "paddingAll": "xs",
                "margin": "sm"
              }
            ],
            "paddingAll": "xs",
            "backgroundColor": "#FFFFFF",
            "cornerRadius": "md",
            "width": width,
            "action": { "type": "uri", "uri": item.url },
            "margin": colIdx === 0 ? "none" : "md" 
          }))
        })),
        "paddingAll": "md"
      };

      if (ecomState.value.body.bgType === 'image') {
        const bgImageProps = ecomState.value.body.bgMode === 'top' 
          ? { "width": "100%", "aspectMode": "width", "align": "start", "offsetTop": "0px" } 
          : { "size": "full", "aspectMode": "cover" };

        bodyConfig.contents.push({
          "type": "box",
          "layout": "vertical",
          "contents": [
            {
              "type": "image",
              "url": ecomState.value.body.bg,
              "position": "absolute",
              ...bgImageProps
            },
            productContent
          ]
        });
      } else {
        bodyConfig.contents.push(productContent);
      }

      const footerContents = [];
      
      if (ecomState.value.footer.textEnabled) {
        footerContents.push({
          "type": "text",
          "text": ecomState.value.footer.text,
          "wrap": true,
          "size": "xs",
          "color": ecomState.value.footer.textColor,
          "align": ecomState.value.footer.textAlign,
          "margin": "md"
        });
      }

      footerContents.push({
        "type": "box",
        "layout": "horizontal",
        "spacing": "md",
        "contents": [
          {
            "type": "button",
            "style": "primary",
            "height": "sm",
            "action": { "type": "uri", "label": ecomState.value.footer.btn1.label, "uri": ecomState.value.footer.btn1.uri },
            "color": ecomState.value.footer.btn1.color
          },
          {
            "type": "button",
            "style": "primary",
            "height": "sm",
            "action": { "type": "uri", "label": ecomState.value.footer.btn2.label, "uri": ecomState.value.footer.btn2.uri },
            "color": ecomState.value.footer.btn2.color
          }
        ]
      });

      const flex = {
        "type": "bubble",
        "size": ecomState.value.body.bubbleSize,
        "body": bodyConfig,
        "footer": {
          "type": "box",
          "layout": "vertical",
          "spacing": "sm",
          "backgroundColor": ecomState.value.footer.bg,
          "contents": footerContents,
          "paddingTop": "md"
        }
      };

      if (ecomState.value.hero.type !== 'none') {
        flex.hero = ecomState.value.hero.type === 'video' ? {
          "type": "video",
          "url": ecomState.value.hero.videoUrl,
          "previewUrl": ecomState.value.hero.url,
          "altContent": {
            "type": "image",
            "size": "full",
            "aspectRatio": ecomState.value.hero.aspectRatio,
            "aspectMode": "cover",
            "url": ecomState.value.hero.url,
            "backgroundColor": "#000000"
          },
          "aspectRatio": ecomState.value.hero.aspectRatio
        } : {
          "type": "image",
          "url": ecomState.value.hero.url,
          "size": "full",
          "aspectRatio": ecomState.value.hero.aspectRatio,
          "aspectMode": "cover",
          "action": { "type": "uri", "uri": ecomState.value.hero.link }
        };
      }

      return flex;
    };

    // è¤‡è£½é›»å­å•†å‹™ç‰ˆ JSON
    const copyEcommerceJson = () => { 
      const el = document.createElement('textarea'); 
      el.value = JSON.stringify(generateEcommerceJson(), null, 2); 
      document.body.appendChild(el); 
      el.select(); 
      document.execCommand('copy'); 
      document.body.removeChild(el); 
      alert('JSON å·²è¤‡è£½ï¼'); 
    };

    // åŸæœ‰æ•¸æ“š
    const flexData = ref({
      type: 'standard', 
      imageUrl: 'https://scdn.line-apps.com/n/channel_devcenter/img/fx/01_1_cafe.png',
      aspectRatio: '20:13', 
      title: 'Brown Cafe', 
      subtitle: 'æ­¡è¿å…‰è‡¨ï¼æ”¯æ´é•·æ–‡æ›è¡Œã€‚', 
      showBadge: true, 
      badgeColor: '#FF0000',
      buttons: [{ label: 'äº†è§£æ›´å¤š', uri: 'https://example.com', color: '#00B900' }],
      
      // å½±ç‰‡æ¨¡æ¿æ•¸æ“š
      headerImg: 'https://aiwe.cc/wp-content/uploads/2025/04/f9ebd0672d3b0ac370272909a493d4db.png',
      headerName: 'TONY', 
      headerTitle: 'LINEè¡ŒéŠ·é”äºº',
      headerDescription: 'ç³»çµ±é–‹ç™¼',
      videoUrl: 'https://voom-obs.line-scdn.net/ho1sEMNWDLB8UUD8RLAYrZjJoJzAxV3cPGT8MeBQ_J2YzD3JIGgELJDl3bm4xeSUUJy9_IhBjCiYfajYJIBEMORdaCXUceRQXDigUOQpZHg/mp4',
      previewUrl: 'https://voom-obs.line-scdn.net/ho1sEMNWDLB8UUD8RLAYrZjJoJzAxV3cPGT8MeBQ_J2YzD3JIGgELJDl3bm4xeSUUJy9_IhBjCiYfajYJIBEMORdaCXUceRQXDigUOQpZHg/m800x1200',
      gridButtons: [
        { emoji: 'ğŸ¤–', label: 'AI è«®è©¢', uri: 'https://liff.line.me/2006625044-bPGxrB53/' },
        { emoji: 'ğŸ¥', label: 'ç”¢å“ä»‹ç´¹', uri: 'https://example.com/video' },
        { emoji: 'ğŸ§¾', label: 'å•†å“å‹éŒ„', uri: 'https://example.com/catalog' },
        { emoji: 'ğŸ“', label: 'é–€å¸‚è³‡è¨Š', uri: 'https://example.com/map' }
      ],
      videoFooterButtons: [
        { label: 'ğŸš€ å•Ÿå‹• AI å°å¹«æ‰‹', uri: 'https://liff.line.me/2006625044-bPGxrB53/index.php/colt_sp/6502/', color: '#C9A24D' },
        { label: 'ğŸ“¤ åˆ†äº«å¥½å‹', uri: 'https://liff.line.me/2006625044-J42EzjkZ/index.php/linecard_12/6816/' }
      ]
    });

    const templates = ref([
      { 
        name: 'æ–‡ç« å‹æ¨¡æ¿', 
        type: 'standard', 
        thumbnail: 'https://scdn.line-apps.com/n/channel_devcenter/img/fx/01_1_cafe.png', 
        payload: { 
          type:'standard', 
          imageUrl:'https://scdn.line-apps.com/n/channel_devcenter/img/fx/01_1_cafe.png', 
          aspectRatio:'20:13', 
          title:'ç¶“å…¸å’–å•¡', 
          subtitle:'æ”¯æ´æ›è¡Œã€‚', 
          showBadge:true, 
          badgeColor:'#FF0000', 
          buttons:[{label:'äº†è§£æ›´å¤š', uri:'#', color:'#00B900'}]
        } 
      },
      { 
        name: 'å½±ç‰‡åç‰‡æ¨¡æ¿', 
        type: 'video', 
        thumbnail: 'https://aiwe.cc/wp-content/uploads/2025/04/f9ebd0672d3b0ac370272909a493d4db.png', 
        payload: { 
          type:'video', 
          headerName:'TONY', 
          headerTitle: 'LINEè¡ŒéŠ·é”äºº',
          headerDescription: 'ç³»çµ±é–‹ç™¼',
          headerImg:'https://aiwe.cc/wp-content/uploads/2025/04/f9ebd0672d3b0ac370272909a493d4db.png', 
          videoUrl:'https://voom-obs.line-scdn.net/ho1sEMNWDLB8UUD8RLAYrZjJoJzAxV3cPGT8MeBQ_J2YzD3JIGgELJDl3bm4xeSUUJy9_IhBjCiYfajYJIBEMORdaCXUceRQXDigUOQpZHg/mp4',
          previewUrl:'https://voom-obs.line-scdn.net/ho1sEMNWDLB8UUD8RLAYrZjJoJzAxV3cPGT8MeBQ_J2YzD3JIGgELJDl3bm4xeSUUJy9_IhBjCiYfajYJIBEMORdaCXUceRQXDigUOQpZHg/m800x1200',
          gridButtons: [
            {emoji:'ğŸ¤–',label:'AI è«®è©¢',uri:'https://liff.line.me/2006625044-bPGxrB53/'},
            {emoji:'ğŸ¥',label:'ç”¢å“ä»‹ç´¹',uri:'https://example.com/video'},
            {emoji:'ğŸ§¾',label:'å•†å“å‹éŒ„',uri:'https://example.com/catalog'},
            {emoji:'ğŸ“',label:'é–€å¸‚è³‡è¨Š',uri:'https://example.com/map'}
          ], 
          videoFooterButtons:[
            {label:'ğŸš€ å•Ÿå‹• AI å°å¹«æ‰‹',uri:'https://liff.line.me/2006625044-bPGxrB53/index.php/colt_sp/6502/',color:'#C9A24D'},
            {label:'ğŸ“¤ åˆ†äº«å¥½å‹',uri:'https://liff.line.me/2006625044-J42EzjkZ/index.php/linecard_12/6816/'}
          ]
        } 
      },
      { 
        name: 'é›»å•†å‹æ¨¡æ¿', 
        type: 'ecommerce', 
        thumbnail: 'https://lihi.cc/l5qqU', 
        payload: {
          type: 'ecommerce',
          ecomState: {
            hero: {
              type: 'video', 
              aspectRatio: '16:9',
              url: "https://lihi.cc/5OXMZ", 
              videoUrl: "https://lihi.cc/YsmAp", 
              link: "https://line.me"
            },
            body: {
              columns: 3,
              bubbleSize: "mega", 
              bgType: "image",
              bgMode: "cover",
              bgColor: "#F8F8F8",
              bg: "https://lihi.cc/l5qqU",
              tagBgColor: "#0D0D0D",
              tagTextColor: "#FFFFFF",
              items: [
                { title: "å•†å“ A", img: "https://lihi.cc/mwMvo", url: "https://line.me" },
                { title: "å•†å“ B", img: "https://lihi.cc/2Nu8G", url: "https://line.me" },
                { title: "å•†å“ C", img: "https://lihi.cc/yRfpn", url: "https://line.me" },
                { title: "å•†å“ D", img: "https://lihi.cc/yRfpn", url: "https://line.me" },
                { title: "å•†å“ E", img: "https://lihi.cc/2Nu8G", url: "https://line.me" },
                { title: "å•†å“ F", img: "https://lihi.cc/mwMvo", url: "https://line.me" }
              ]
            },
            footer: {
              bg: "#ffffff", 
              textEnabled: false,
              text: "â€» è«‹æ³¨æ„ï¼šå„ªæƒ å•†å“æ•¸é‡æœ‰é™ï¼Œå”®å®Œç‚ºæ­¢ã€‚",
              textColor: "#666666",
              textAlign: "center",
              btn1: { label: "å“ç‰Œæ•…äº‹", color: "#000000", uri: "https://liff.line.me/2008704329-cTkwlRHm" },
              btn2: { label: "å¥½å‹åˆ†äº«", color: "#000000", uri: "line://nv/recommendOA/@754tjssx" }
            }
          }
        }
      }
    ]);

    // è¨ˆç®—å±¬æ€§
    const pageTitle = computed(() => {
      const titles = {
        'dashboard': 'å„€è¡¨æ¿ç¸½è¦½',
        'messages': 'æ’ä»¶é–‹ç™¼ç®¡ç†å¹³å°',
        'templates': 'æ’ä»¶æ¨¡æ¿é¸æ“‡ä¸­å¿ƒ',
        'projects': 'å°ˆæ¡ˆç®¡ç†'
      };
      return titles[currentTab.value] || 'LINEOA æ’ä»¶ç®¡ç†å¹³å°';
    });
    
    const filteredProjects = computed(() => {
      if (!projectSearch.value) return projects.value;
      const search = projectSearch.value.toLowerCase();
      return projects.value.filter(project => 
        (project.name && project.name.toLowerCase().includes(search)) ||
        (project.type && project.type.toLowerCase().includes(search)) ||
        (project.description && project.description.toLowerCase().includes(search))
      );
    });

    const generatedJson = computed(() => {
      if (flexData.value.type === 'ecommerce') {
        return generateEcommerceJson();
      }
      
      if (flexData.value.type === 'standard') {
        const contents = [
          { 
            type: "image", 
            url: flexData.value.imageUrl, 
            size: "full", 
            aspectRatio: flexData.value.aspectRatio, 
            animated: true 
          }, 
          { 
            type: "text", 
            text: flexData.value.title, 
            weight: "bold", 
            size: "xl", 
            align: "center", 
            margin: "sm" 
          }, 
          { 
            type: "text", 
            text: flexData.value.subtitle, 
            size: "sm", 
            margin: "sm", 
            offsetStart: "5px", 
            wrap: true 
          }
        ];
        
        return { 
          type: "bubble", 
          body: { 
            type: "box", 
            layout: "vertical", 
            paddingAll: "0px", 
            contents: contents 
          }, 
          footer: { 
            type: "box", 
            layout: "vertical", 
            spacing: "sm", 
            contents: flexData.value.buttons.map(b => ({ 
              type: "button", 
              style: "primary", 
              color: b.color, 
              height: "sm", 
              action: { 
                type: "uri", 
                label: b.label, 
                uri: b.uri 
              } 
            })) 
          } 
        };
      } else {
        return { 
          type: "bubble",
          size: "mega",
          header: {
            type: "box",
            layout: "horizontal",
            spacing: "md",
            paddingAll: "8px",
            backgroundColor: "#1A1B1E",
            contents: [
              {
                type: "image",
                url: flexData.value.headerImg,
                size: "xs",
                aspectRatio: "1:1",
                aspectMode: "cover",
                gravity: "center"
              },
              {
                type: "box",
                layout: "vertical",
                spacing: "xs",
                flex: 3,
                contents: [
                  {
                    type: "text",
                    text: flexData.value.headerName || "TONY",
                    weight: "bold",
                    size: "lg",
                    color: "#D4AF37"
                  },
                  {
                    type: "text",
                    text: flexData.value.headerTitle || "LINEè¡ŒéŠ·é”äºº",
                    size: "sm",
                    color: "#E6E6E6"
                  },
                  {
                    type: "text",
                    text: flexData.value.headerDescription || "ç³»çµ±é–‹ç™¼",
                    size: "xs",
                    color: "#A0A0A0",
                    wrap: true
                  }
                ]
              }
            ]
          },
          hero: {
            type: "video",
            url: flexData.value.videoUrl,
            previewUrl: flexData.value.previewUrl,
            aspectRatio: "800:500",
            altContent: {
              type: "image",
              url: flexData.value.previewUrl,
              size: "full",
              aspectRatio: "800:500",
              aspectMode: "cover"
            }
          },
          body: {
            type: "box",
            layout: "vertical",
            paddingAll: "8px",
            contents: [
              {
                type: "box",
                layout: "vertical",
                spacing: "sm",
                paddingAll: "12px",
                backgroundColor: "#1F2024",
                cornerRadius: "14px",
                contents: [
                  {
                    type: "box",
                    layout: "horizontal",
                    spacing: "sm",
                    contents: [
                      {
                        type: "box",
                        layout: "vertical",
                        paddingAll: "12px",
                        backgroundColor: "#2A2C31",
                        cornerRadius: "12px",
                        action: {
                          type: "uri",
                          label: flexData.value.gridButtons[0]?.label || "AI è«®è©¢",
                          uri: flexData.value.gridButtons[0]?.uri || "#"
                        },
                        contents: [
                          {
                            type: "text",
                            text: flexData.value.gridButtons[0]?.emoji || "ğŸ¤–",
                            size: "xl",
                            align: "center"
                          },
                          {
                            type: "text",
                            text: flexData.value.gridButtons[0]?.label || "AI è«®è©¢",
                            size: "sm",
                            align: "center",
                            color: "#E6E6E6"
                          }
                        ]
                      },
                      {
                        type: "box",
                        layout: "vertical",
                        paddingAll: "12px",
                        backgroundColor: "#2A2C31",
                        cornerRadius: "12px",
                        action: {
                          type: "uri",
                          label: flexData.value.gridButtons[1]?.label || "ç”¢å“ä»‹ç´¹",
                          uri: flexData.value.gridButtons[1]?.uri || "#"
                        },
                        contents: [
                          {
                            type: "text",
                            text: flexData.value.gridButtons[1]?.emoji || "ğŸ¥",
                            size: "xl",
                            align: "center"
                          },
                          {
                            type: "text",
                            text: flexData.value.gridButtons[1]?.label || "ç”¢å“ä»‹ç´¹",
                            size: "sm",
                            align: "center",
                            color: "#E6E6E6"
                          }
                        ]
                      }
                    ]
                  },
                  {
                    type: "box",
                    layout: "horizontal",
                    spacing: "sm",
                    contents: [
                      {
                        type: "box",
                        layout: "vertical",
                        paddingAll: "12px",
                        backgroundColor: "#2A2C31",
                        cornerRadius: "12px",
                        action: {
                          type: "uri",
                          label: flexData.value.gridButtons[2]?.label || "å•†å“å‹éŒ„",
                          uri: flexData.value.gridButtons[2]?.uri || "#"
                        },
                        contents: [
                          {
                            type: "text",
                            text: flexData.value.gridButtons[2]?.emoji || "ğŸ§¾",
                            size: "xl",
                            align: "center"
                          },
                          {
                            type: "text",
                            text: flexData.value.gridButtons[2]?.label || "å•†å“å‹éŒ„",
                            size: "sm",
                            align: "center",
                            color: "#E6E6E6"
                          }
                        ]
                      },
                      {
                        type: "box",
                        layout: "vertical",
                        paddingAll: "12px",
                        backgroundColor: "#2A2C31",
                        cornerRadius: "12px",
                        action: {
                          type: "uri",
                          label: flexData.value.gridButtons[3]?.label || "é–€å¸‚è³‡è¨Š",
                          uri: flexData.value.gridButtons[3]?.uri || "#"
                        },
                        contents: [
                          {
                            type: "text",
                            text: flexData.value.gridButtons[3]?.emoji || "ğŸ“",
                            size: "xl",
                            align: "center"
                          },
                          {
                            type: "text",
                            text: flexData.value.gridButtons[3]?.label || "é–€å¸‚è³‡è¨Š",
                            size: "sm",
                            align: "center",
                            color: "#E6E6E6"
                          }
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          },
          footer: {
            type: "box",
            layout: "vertical",
            spacing: "sm",
            paddingAll: "8px",
            contents: [
              {
                type: "button",
                style: "primary",
                color: flexData.value.videoFooterButtons[0]?.color || "#C9A24D",
                height: "sm",
                action: {
                  type: "uri",
                  label: flexData.value.videoFooterButtons[0]?.label || "ğŸš€ å•Ÿå‹• AI å°å¹«æ‰‹",
                  uri: flexData.value.videoFooterButtons[0]?.uri || "#"
                }
              },
              {
                type: "button",
                style: "secondary",
                height: "sm",
                action: {
                  type: "uri",
                  label: flexData.value.videoFooterButtons[1]?.label || "ğŸ“¤ åˆ†äº«å¥½å‹",
                  uri: flexData.value.videoFooterButtons[1]?.uri || "#"
                }
              }
            ]
          },
          styles: {
            body: {
              backgroundColor: "#0F0F10"
            },
            footer: {
              backgroundColor: "#0F0F10"
            }
          }
        };
      }
    });

    // æª¢æŸ¥å·¥ä½œè¡¨ç‹€æ…‹
    const checkSheetsStatus = async () => {
      try {
        const response = await fetch(`${WORKER_URL}/api/sheets/status`);
        const data = await response.json();
        
        if (data.success) {
          const missingSheets = Object.entries(data.sheets)
            .filter(([_, exists]) => !exists)
            .map(([name]) => name);
          
          if (missingSheets.length > 0) {
            console.log('ç¼ºå°‘å·¥ä½œè¡¨ï¼Œæ­£åœ¨åˆå§‹åŒ–...', missingSheets);
            await initializeSheets();
          }
        }
      } catch (error) {
        console.error('æª¢æŸ¥å·¥ä½œè¡¨ç‹€æ…‹å¤±æ•—:', error);
      }
    };
    
    // åˆå§‹åŒ–å·¥ä½œè¡¨
    const initializeSheets = async () => {
      try {
        const response = await fetch(`${WORKER_URL}/api/sheets/initialize`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();
        console.log('å·¥ä½œè¡¨åˆå§‹åŒ–çµæœ:', data);
        alert('Google Sheets åˆå§‹åŒ–å®Œæˆï¼');
      } catch (error) {
        console.error('åˆå§‹åŒ–å·¥ä½œè¡¨å¤±æ•—:', error);
        alert('åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°');
      }
    };

    // æ–¹æ³•
    const switchTab = (t) => {
      currentTab.value = t;
      if (t === 'projects') {
        loadProjects();
      }
    };
    
    const toggleSidebarMenu = () => { 
      if (isSidebarCollapsed.value) {
        isSidebarCollapsed.value = false;
        setTimeout(() => {
          isMessageMenuOpen.value = true;
        }, 100);
      } else {
        isMessageMenuOpen.value = !isMessageMenuOpen.value;
      }
    };
    
    const switchSubTab = (t, s) => { 
      currentTab.value = t; 
      currentSubTab.value = s; 
      flexData.value.type = (s === 'video' ? 'video' : s === 'ecommerce' ? 'ecommerce' : 'standard'); 
      
      // åˆå§‹åŒ–é›»å­å•†å‹™æ­·å²è¨˜éŒ„
      if (s === 'ecommerce') {
        ecomHistory.value = [];
        saveEcomHistory();
      }
    };
    
    const applyTemplate = (tpl) => { 
      if (tpl.type === 'ecommerce') {
        ecomState.value = JSON.parse(JSON.stringify(tpl.payload.ecomState));
      } else {
        flexData.value = JSON.parse(JSON.stringify(tpl.payload)); 
      }
      currentTab.value = 'messages'; 
      currentSubTab.value = (tpl.type === 'video' ? 'video' : tpl.type === 'ecommerce' ? 'ecommerce' : 'single'); 
    };
    
    const addButton = () => { 
      if (flexData.value.buttons.length < 3) {
        flexData.value.buttons.push({ 
          label: 'æ–°æŒ‰éˆ•', 
          uri: 'https://example.com', 
          color: '#00B900' 
        }); 
      }
    };
    
    const removeButton = (idx) => flexData.value.buttons.splice(idx, 1);
    
    const copyJson = () => { 
      const el = document.createElement('textarea'); 
      el.value = JSON.stringify(generatedJson.value, null, 2); 
      document.body.appendChild(el); 
      el.select(); 
      document.execCommand('copy'); 
      document.body.removeChild(el); 
      alert('JSON å·²è¤‡è£½ï¼'); 
    };

    const liffLogin = () => {
      if (isInIframe.value) window.open("https://liff.line.me/2008541971-XPIDtaaj", "_blank");
      else liff.login();
    };

    // ç›´æ¥æ¨æ’­
    const shareToLine = () => {
      if (!liff.isLoggedIn()) { 
        alert("è«‹å…ˆç™»å…¥ LINEã€‚"); 
        liffLogin(); 
        return; 
      }
      liff.shareTargetPicker([{ 
        type: "flex", 
        altText: "åˆ†äº«å®¢è£½åŒ–æ’ä»¶è¨Šæ¯", 
        contents: flexData.value.type === 'ecommerce' ? generateEcommerceJson() : generatedJson.value
      }])
      .then(res => { 
        if (res) alert("ç™¼é€æˆåŠŸï¼"); 
      })
      .catch(err => alert("ç™¼é€å¤±æ•—ï¼š" + err));
    };

    // å„²å­˜åˆ° Cloudflare Worker
    const saveToCloudflare = async () => {
      if (!liffProfile.value) {
        alert("è«‹å…ˆç™»å…¥ LINE");
        liffLogin();
        return;
      }

      isSaving.value = true;
      try {
        const payload = {
          userId: liffProfile.value.userId,
          type: flexData.value.type,
          name: flexData.value.type === 'ecommerce' ? 'é›»å•†å‹å°ˆæ¡ˆ' : (flexData.value.title || flexData.value.headerName || 'æœªå‘½åå°ˆæ¡ˆ'),
          params: flexData.value.type === 'ecommerce' ? ecomState.value : flexData.value,
          flexPayload: flexData.value.type === 'ecommerce' ? generateEcommerceJson() : generatedJson.value
        };

        const response = await fetch(`${WORKER_URL}/api/plugins/save`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        const data = await response.json();
        
        if (data.success) {
          alert('æ•¸æ“šå·²æˆåŠŸå„²å­˜åˆ° Google Sheetsï¼');
        } else {
          alert('å„²å­˜å¤±æ•—: ' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
        }
        
      } catch (error) {
        console.error('å„²å­˜å¤±æ•—:', error);
        alert('å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°');
      } finally {
        isSaving.value = false;
      }
    };
    
    // è¼‰å…¥å°ˆæ¡ˆåˆ—è¡¨
    const loadProjects = async () => {
      loadingProjects.value = true;
      try {
        const response = await fetch(`${WORKER_URL}/api/projects`);
        const data = await response.json();
        
        if (data.success) {
          projects.value = data.projects
            .filter(project => project.name && project.name.trim() !== '')
            .map(project => ({
              ...project,
              name: project.name || `å°ˆæ¡ˆ ${project.id}`,
              description: project.description || '',
              type: project.type || 'standard',
              created_at: project.created_at || new Date().toISOString()
            }));
        } else {
          console.error('è¼‰å…¥å°ˆæ¡ˆå¤±æ•—:', data.error);
          projects.value = [];
        }
      } catch (error) {
        console.error('è¼‰å…¥å°ˆæ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
        projects.value = [];
      } finally {
        loadingProjects.value = false;
      }
    };
    
    // å„²å­˜å°ˆæ¡ˆ
    const saveProject = async (isUpdate = false) => {
      if (!newProject.value.name && !isUpdate) {
        alert('è«‹è¼¸å…¥å°ˆæ¡ˆåç¨±');
        return;
      }

      isSaving.value = true;
      try {
        const payload = {
          name: isUpdate ? currentProjectName.value : newProject.value.name,
          description: newProject.value.description,
          type: flexData.value.type,
          data: flexData.value.type === 'ecommerce' ? JSON.stringify(ecomState.value) : JSON.stringify(flexData.value),
          flex_json: flexData.value.type === 'ecommerce' ? JSON.stringify(generateEcommerceJson()) : JSON.stringify(generatedJson.value)
        };

        if (isUpdate) {
          payload.id = currentProjectId.value;
        }

        const endpoint = isUpdate ? '/api/projects/update' : '/api/projects/create';
        const response = await fetch(`${WORKER_URL}${endpoint}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        const data = await response.json();
        
        if (data.success) {
          alert(isUpdate ? 'å°ˆæ¡ˆæ›´æ–°æˆåŠŸï¼' : 'å°ˆæ¡ˆå„²å­˜æˆåŠŸï¼');
          
          if (!isUpdate) {
            currentProjectId.value = data.id;
            currentProjectName.value = payload.name;
            showNewProjectModal.value = false;
            newProject.value = {
              name: '',
              description: '',
              type: 'standard'
            };
          }
          
          loadProjects();
          if (!isUpdate) {
            switchTab('projects');
          }
        } else {
          alert('å„²å­˜å¤±æ•—: ' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
        }
      } catch (error) {
        console.error('å„²å­˜å°ˆæ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
        alert('å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      } finally {
        isSaving.value = false;
      }
    };
    
    // è¼‰å…¥å°ˆæ¡ˆ
    const loadProject = (project) => {
      try {
        if (project.data) {
          const projectData = typeof project.data === 'string' ? 
            JSON.parse(project.data) : project.data;
          
          if (project.type === 'ecommerce') {
            ecomState.value = projectData;
          } else {
            flexData.value = projectData;
          }
          
          currentProjectId.value = project.id;
          currentProjectName.value = project.name;
          
          currentTab.value = 'messages';
          currentSubTab.value = project.type === 'video' ? 'video' : project.type === 'ecommerce' ? 'ecommerce' : 'single';
          
          alert(`å·²è¼‰å…¥å°ˆæ¡ˆ: ${project.name}`);
        }
      } catch (error) {
        console.error('è¼‰å…¥å°ˆæ¡ˆè³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
        alert('è¼‰å…¥å°ˆæ¡ˆå¤±æ•—');
      }
    };
    
    // åˆªé™¤å°ˆæ¡ˆ
    const deleteProject = (projectId) => {
      projectToDelete.value = projectId;
      showDeleteConfirm.value = true;
    };

    const confirmDelete = async () => {
      try {
        const response = await fetch(`${WORKER_URL}/api/projects/delete`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: projectToDelete.value })
        });
        
        const data = await response.json();
        
        if (data.success) {
          alert('å°ˆæ¡ˆåˆªé™¤æˆåŠŸï¼');
          
          if (currentProjectId.value === projectToDelete.value) {
            clearCurrentProject();
          }
          
          loadProjects();
        } else {
          alert('åˆªé™¤å¤±æ•—: ' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
        }
      } catch (error) {
        console.error('åˆªé™¤å°ˆæ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
        alert('åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      } finally {
        showDeleteConfirm.value = false;
        projectToDelete.value = null;
      }
    };
    
    // æ¸…é™¤ç•¶å‰å°ˆæ¡ˆ
    const clearCurrentProject = () => {
      currentProjectId.value = null;
      currentProjectName.value = '';
      if (flexData.value.type === 'ecommerce') {
        ecomState.value = {
          hero: {
            type: 'video', 
            aspectRatio: '16:9',
            url: "https://lihi.cc/5OXMZ", 
            videoUrl: "https://lihi.cc/YsmAp", 
            link: "https://line.me"
          },
          body: {
            columns: 3,
            bubbleSize: "mega", 
            bgType: "image",
            bgMode: "cover",
            bgColor: "#F8F8F8",
            bg: "https://lihi.cc/l5qqU",
            tagBgColor: "#0D0D0D",
            tagTextColor: "#FFFFFF",
            items: [
              { title: "å•†å“ A", img: "https://lihi.cc/mwMvo", url: "https://line.me" },
              { title: "å•†å“ B", img: "https://lihi.cc/2Nu8G", url: "https://line.me" },
              { title: "å•†å“ C", img: "https://lihi.cc/yRfpn", url: "https://line.me" }
            ]
          },
          footer: {
            bg: "#ffffff", 
            textEnabled: false,
            text: "â€» è«‹æ³¨æ„ï¼šå„ªæƒ å•†å“æ•¸é‡æœ‰é™ï¼Œå”®å®Œç‚ºæ­¢ã€‚",
            textColor: "#666666",
            textAlign: "center",
            btn1: { label: "å“ç‰Œæ•…äº‹", color: "#000000", uri: "https://liff.line.me/2008704329-cTkwlRHm" },
            btn2: { label: "å¥½å‹åˆ†äº«", color: "#000000", uri: "line://nv/recommendOA/@754tjssx" }
          }
        };
      } else {
        flexData.value = {
          type: 'standard', 
          imageUrl: 'https://scdn.line-apps.com/n/channel_devcenter/img/fx/01_1_cafe.png',
          aspectRatio: '20:13', 
          title: '', 
          subtitle: '', 
          showBadge: true, 
          badgeColor: '#FF0000',
          buttons: [{ label: 'äº†è§£æ›´å¤š', uri: 'https://example.com', color: '#00B900' }]
        };
      }
    };
    
    // æ¨æ’­å°ˆæ¡ˆ
    const pushProject = async (project) => {
      if (!liffProfile.value) {
        alert("è«‹å…ˆç™»å…¥ LINE");
        liffLogin();
        return;
      }

      try {
        const payload = {
          projectId: project.id,
          userId: liffProfile.value.userId
        };

        const response = await fetch(`${WORKER_URL}/api/plugins/push`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        const data = await response.json();
        
        if (data.success) {
          alert('å°ˆæ¡ˆæ¨æ’­æˆåŠŸï¼');
        } else {
          alert('æ¨æ’­å¤±æ•—: ' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
        }
      } catch (error) {
        console.error('æ¨æ’­å°ˆæ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
        alert('æ¨æ’­å¤±æ•—');
      }
    };
    
    // æ ¼å¼åŒ–æ—¥æœŸ
    const formatDate = (dateString) => {
      if (!dateString) return 'ç„¡æ—¥æœŸ';
      try {
        const date = new Date(dateString);
        return date.toLocaleDateString('zh-TW', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch (e) {
        return 'æ—¥æœŸæ ¼å¼éŒ¯èª¤';
      }
    };

    return {
      isSidebarCollapsed, 
      isMessageMenuOpen, 
      currentTab, 
      currentSubTab, 
      flexData, 
      ecomState,
      templates,
      projects,
      projectSearch,
      loadingProjects,
      newProject,
      currentProjectId,
      currentProjectName,
      showNewProjectModal,
      showDeleteConfirm,
      pageTitle, 
      generatedJson, 
      filteredProjects,
      isSaving, 
      isLoggedIn, 
      isInIframe,
      switchTab, 
      toggleSidebarMenu, 
      switchSubTab, 
      applyTemplate, 
      addButton, 
      removeButton, 
      copyJson, 
      saveToCloudflare, 
      shareToLine,
      loadProjects,
      saveProject,
      loadProject,
      deleteProject,
      confirmDelete,
      clearCurrentProject,
      pushProject,
      checkSheetsStatus,
      initializeSheets,
      formatDate,
      liffLogin,
      // é›»å­å•†å‹™ç‰ˆæ–¹æ³•
      updateHeroType,
      updateBodyType,
      updateFooterTextAlign,
      updateEcomItem,
      addEcomItem,
      deleteEcomItem,
      getAspectClass,
      getTextAlignClass,
      saveEcomHistory,
      generateEcommerceJson,
      copyEcommerceJson
    };
  }
}).mount('#app');
</script>
</body>
</html>
